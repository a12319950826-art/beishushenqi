<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìö Â≠¶‰π†ÁÆ°ÁêÜÁ≥ªÁªü</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ‰æßËæπÊ†è */
    .sidebar {
      width: 300px;
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s;
    }

    .sidebar-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .sidebar-header h1 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    /* ÁªüËÆ°Èù¢Êùø */
    .stats-panel {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }

    .stats-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 13px;
      border-bottom: 1px solid #e9ecef;
    }

    .stats-item:last-child {
      border-bottom: none;
    }

    .stats-label {
      color: #666;
    }

    .stats-value {
      font-weight: 600;
      color: #667eea;
    }

    .stats-value.warning {
      color: #ffc107;
    }

    .stats-value.danger {
      color: #dc3545;
    }

    .stats-value.success {
      color: #28a745;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
    }

    .book-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .book-item {
      padding: 12px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      position: relative;
    }

    .book-item:hover {
      background: #e9ecef;
      transform: translateX(3px);
    }

    .book-item.active {
      background: #e7f3ff;
      border-left-color: #667eea;
    }

    .book-item-name {
      font-weight: 600;
      margin-bottom: 5px;
      padding-right: 30px;
    }

    .book-item-progress {
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }

    .book-item-deadline {
      font-size: 11px;
      margin-top: 5px;
      padding: 3px 6px;
      border-radius: 4px;
      display: inline-block;
    }

    .book-item-deadline.danger {
      background: #fff5f5;
      color: #dc3545;
      font-weight: 600;
    }

    .book-item-deadline.warning {
      background: #fffef5;
      color: #ffc107;
      font-weight: 600;
    }

    .book-item-deadline.success {
      background: #f0fff4;
      color: #28a745;
    }

    .book-settings-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #ddd;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      opacity: 0;
      transition: all 0.2s;
    }

    .book-item:hover .book-settings-btn {
      opacity: 1;
    }

    .book-settings-btn:hover {
      background: white;
      transform: scale(1.1);
    }

    .add-book-btn {
      margin: 15px;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .add-book-btn:hover {
      background: #5568d3;
    }

    .add-book-btn[style*="background: #28a745"]:hover {
      background: #218838 !important;
    }

    /* ‰∏ªÂÜÖÂÆπÂå∫ */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .toolbar {
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e9ecef;
      color: #333;
    }

    .btn-secondary:hover {
      background: #dee2e6;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn.active {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }

    .content-text {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.8;
      white-space: pre-wrap;
      font-size: 15px;
      position: relative;
    }

    /* MarkdownÊ†∑Âºè */
    .content-text h1 {
      font-size: 28px;
      margin: 20px 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    .content-text h2 {
      font-size: 24px;
      margin: 18px 0 12px 0;
      color: #667eea;
    }

    .content-text h3 {
      font-size: 20px;
      margin: 15px 0 10px 0;
    }

    .content-text ul, .content-text ol {
      margin: 10px 0;
      padding-left: 30px;
    }

    .content-text li {
      margin: 5px 0;
    }

    .content-text code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 14px;
    }

    .content-text pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .content-text blockquote {
      border-left: 4px solid #667eea;
      padding-left: 15px;
      margin: 10px 0;
      color: #666;
      font-style: italic;
    }

    .content-text table {
      border-collapse: collapse;
      width: 100%;
      margin: 15px 0;
      background: white;
    }

    .content-text table th,
    .content-text table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    .content-text table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    .content-text table tr:hover {
      background: #f8f9fa;
    }

    .study-block table th,
    .study-block table td {
      border: 1px solid #ddd;
      padding: 10px;
    }

    .study-block table th {
      background: rgba(255,255,255,0.7);
    }

    .text-line {
      position: relative;
      padding: 2px 0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .text-line.selecting:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .text-line.selected {
      background: rgba(102, 126, 234, 0.2);
      border: 2px dashed #667eea;
    }

    .study-block {
      position: relative;
      padding: 8px;
      margin: 4px 0;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .study-block-info {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .study-block:hover .study-block-info {
      opacity: 1;
    }

    .study-count {
      background: rgba(255,255,255,0.9);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .study-plus-btn {
      background: #28a745;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .study-plus-btn:hover {
      background: #218838;
      transform: scale(1.1);
    }

    .study-delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .study-delete-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }

    .study-important-btn {
      background: rgba(255,193,7,0.9);
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .study-important-btn:hover {
      transform: scale(1.1);
    }

    .study-important-btn.active {
      background: #ffc107;
    }

    .study-block.important {
      border: 3px solid #ffc107;
      box-shadow: 0 0 10px rgba(255,193,7,0.3);
    }

    .study-block.important::before {
      content: '‚≠ê ÈáçÁÇπ';
      position: absolute;
      top: -12px;
      left: 10px;
      background: #ffc107;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    /* ‰ªªÂä°ÊèêÈÜíÈù¢Êùø */
    .task-panel {
      width: 380px;
      background: white;
      border-left: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s;
    }

    .task-panel-header {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }

    .task-panel-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }

    .task-tab {
      flex: 1;
      padding: 8px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      font-size: 13px;
      transition: all 0.2s;
    }

    .task-tab:hover {
      background: #f8f9fa;
    }

    .task-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .task-panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-panel-title h3 {
      font-size: 16px;
    }

    .task-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .task-item {
      padding: 12px;
      margin-bottom: 8px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .task-item:hover {
      border-color: #667eea;
      transform: translateX(-3px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .task-item.urgent {
      border-left: 3px solid #dc3545;
      background: #fff5f5;
    }

    .task-item.due-soon {
      border-left: 3px solid #ffc107;
      background: #fffef5;
    }

    .task-item.normal {
      border-left: 3px solid #28a745;
    }

    .task-item-book {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .task-item-preview {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .task-item-meta {
      font-size: 11px;
      color: #999;
      display: flex;
      justify-content: space-between;
    }

    /* Â≠¶‰π†ÁªüËÆ°ÂàóË°® */
    .stats-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .stats-block-item {
      padding: 10px;
      margin-bottom: 8px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .stats-block-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .stats-block-book {
      font-weight: 600;
      font-size: 13px;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stats-block-content {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .stats-block-progress {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }

    .stats-block-bar {
      flex: 1;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      margin: 0 10px;
      overflow: hidden;
    }

    .stats-block-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
    }


    /* Ê®°ÊÄÅÊ°Ü */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-header h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 200px;
      font-family: monospace;
      resize: vertical;
    }

    .form-group input[type="file"] {
      padding: 8px;
    }

    .form-row {
      display: flex;
      gap: 10px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .info-box {
      background: #e7f3ff;
      border: 1px solid #667eea;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 13px;
      line-height: 1.6;
    }

    .info-box.warning {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    .info-box.success {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    .info-box.danger {
      background: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    .format-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }

    .format-tab {
      padding: 6px 12px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .format-tab:hover {
      background: #e9ecef;
    }

    .format-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    /* ÂêåÊ≠•ÈÄâÈ°πÂç°Ê†∑Âºè */
    .sync-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .sync-option-card {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      transition: all 0.2s;
    }

    .sync-option-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .sync-option-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .sync-option-icon {
      font-size: 24px;
    }

    .sync-option-header h3 {
      font-size: 16px;
      margin: 0;
      flex: 1;
    }

    .sync-option-badge {
      background: #28a745;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .sync-option-badge.recommended {
      background: #ffc107;
      color: #333;
    }

    .sync-option-desc {
      color: #666;
      font-size: 13px;
      margin-bottom: 12px;
    }

    .sync-option-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .sync-option-actions .btn {
      flex: 1;
      min-width: 140px;
    }

    /* Êñá‰ª∂Â§πÂõæÊ†áÊåâÈíÆ */
    .folder-icon-btn {
      width: 50px;
      height: 50px;
      font-size: 24px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .folder-icon-btn:hover {
      border-color: #667eea;
      transform: scale(1.1);
    }

    .folder-icon-btn.selected {
      border-color: #667eea;
      background: #e7f3ff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    /* Êñá‰ª∂Â§πÈ°πÊ†∑Âºè */
    .folder-item {
      padding: 10px 12px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .folder-item:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
      transform: translateX(3px);
    }

    .folder-icon {
      font-size: 18px;
    }

    .folder-name {
      flex: 1;
    }

    .folder-count {
      font-size: 11px;
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .folder-toggle {
      font-size: 12px;
      color: #666;
      transition: transform 0.2s;
    }

    .folder-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .folder-settings-btn {
      background: rgba(255,255,255,0.9);
      border: 1px solid #ddd;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      opacity: 0;
      transition: all 0.2s;
    }

    .folder-item:hover .folder-settings-btn {
      opacity: 1;
    }

    .folder-settings-btn:hover {
      background: white;
      transform: scale(1.1);
    }

    .folder-books {
      margin-left: 20px;
    }

    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @media (max-width: 968px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 100;
        transform: translateX(-100%);
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .task-panel {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        z-index: 100;
        transform: translateX(100%);
      }

      .task-panel.show {
        transform: translateX(0);
      }

      .mobile-toggle {
        display: block !important;
      }
    }

    .mobile-toggle {
      display: none;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    /* ÊªöÂä®Êù°Ê†∑Âºè */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
/* ÁßªÂä®Á´ØÂÖ≥Èó≠ÊåâÈíÆ */
.mobile-close-btn,
.mobile-close-btn-task {
  display: none;
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 20px;
  line-height: 1;
  cursor: pointer;
  transition: all 0.2s;
}

.mobile-close-btn:hover,
.mobile-close-btn-task:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.1);
}

.mobile-close-btn-task {
  background: rgba(102, 126, 234, 0.2);
  color: #667eea;
}

.mobile-close-btn-task:hover {
  background: rgba(102, 126, 234, 0.3);
}

@media (max-width: 968px) {
  .mobile-close-btn,
  .mobile-close-btn-task {
    display: block !important;
  }
}

  </style>
</head>
<body>
  <div class="container">
    <!-- ‰æßËæπÊ†è -->
    <div class="sidebar" id="sidebar">
<div class="sidebar-header">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h1>üìö Â≠¶‰π†ÁÆ°ÁêÜÁ≥ªÁªü</h1>
      <p style="font-size: 12px; opacity: 0.9;">Êô∫ËÉΩÂ§ç‰π† ¬∑ È´òÊïàÂ≠¶‰π†</p>
    </div>
    <button class="mobile-close-btn" onclick="app.toggleSidebar()" style="display: none;">‚úï</button>
  </div>
</div>


      <!-- ÂÖ®Â±ÄÁªüËÆ°Èù¢Êùø -->
      <div class="stats-panel" id="statsPanel">
        <div class="stats-item">
          <span class="stats-label">üìö ÊÄª‰π¶Á±çÊï∞</span>
          <span class="stats-value" id="totalBooks">0</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">üìù ÊÄªÂ≠¶‰π†Âå∫Âùó</span>
          <span class="stats-value" id="totalBlocks">0</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">‚úÖ Â∑≤Â≠¶‰π†Âå∫Âùó</span>
          <span class="stats-value" id="studiedBlocks">0</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">üéØ ÊÄªÁõÆÊ†áÊ¨°Êï∞</span>
          <span class="stats-value" id="totalTargetStudies">0</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">üìä Â∑≤ÂÆåÊàêÊ¨°Êï∞</span>
          <span class="stats-value" id="completedStudies">0</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">‚è∞ Âπ≥ÂùáÂ≠¶‰π†ÈÄüÂ∫¶</span>
          <span class="stats-value" id="avgSpeed">-</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">üî• ÂÆåÊàêÊ¶ÇÁéá</span>
          <span class="stats-value" id="completionProb">-</span>
        </div>
        <div class="stats-item" style="flex-direction: column; align-items: stretch;">
          <span class="stats-label" style="margin-bottom: 5px;">ÊÄª‰ΩìËøõÂ∫¶</span>
          <div class="progress-bar-container">
            <div class="progress-bar" id="overallProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="book-list" id="bookList">
        <div class="empty-state">
          <div class="empty-state-icon">üìñ</div>
          <p>ËøòÊ≤°ÊúâÊ∑ªÂä†‰π¶Á±ç</p>
          <p style="font-size: 12px; margin-top: 5px;">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂºÄÂßã</p>
        </div>
      </div>
      <button class="add-book-btn" onclick="app.showCreateFolderModal()" style="background: #ffc107; color: #333;">üìÅ ÂàõÂª∫Êñá‰ª∂Â§π</button>
      <button class="add-book-btn" onclick="app.showAddBookModal()" style="margin-top: 8px;">+ Ê∑ªÂä†‰π¶Á±ç</button>
      <button class="add-book-btn" onclick="app.showBatchImportModal()" style="background: #28a745; margin-top: 8px;">üìö ÊâπÈáèÂØºÂÖ•</button>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="main-content">
      <div class="toolbar">
        <button class="btn mobile-toggle btn-secondary" onclick="app.toggleSidebar()">‚ò∞ ËèúÂçï</button>
        <button class="btn btn-secondary" id="selectModeBtn" onclick="app.toggleSelectMode()">‚úèÔ∏è ÈÄâÊã©Ê®°Âºè</button>
        <div style="flex: 1"></div>
        <button class="btn btn-secondary" onclick="app.showAnkiExportModal()">üìá ÂØºÂá∫Anki</button>
        <button class="btn btn-secondary" onclick="app.showSyncModal()">üîÑ ÂêåÊ≠•Êï∞ÊçÆ</button>
        <button class="btn mobile-toggle btn-secondary" onclick="app.toggleTaskPanel()">üìã ‰ªªÂä°</button>
      </div>

      <div class="content-area" id="contentArea">
        <div class="content-text" id="contentText">
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <p>ËØ∑ÈÄâÊã©‰∏ÄÊú¨‰π¶Á±çÂºÄÂßãÂ≠¶‰π†</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ‰ªªÂä°ÊèêÈÜíÈù¢Êùø -->
    <div class="task-panel" id="taskPanel">
<div class="task-panel-header">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h3 style="margin: 0;">‰ªªÂä°Èù¢Êùø</h3>
    <button class="mobile-close-btn-task" onclick="app.toggleTaskPanel()">‚úï</button>
  </div>
  <div class="task-panel-tabs">
    <div class="task-tab active" onclick="app.switchTaskTab('tasks')">üìã Â≠¶‰π†‰ªªÂä°</div>
    <div class="task-tab" onclick="app.switchTaskTab('stats')">üìä Â≠¶‰π†ÁªüËÆ°</div>
  </div>
  <div class="task-panel-title">
    <h3 id="taskPanelTitle">Â≠¶‰π†‰ªªÂä°</h3>
    <span id="taskCount" style="color: #667eea; font-weight: 600;">0</span>
  </div>
</div>

      
      <!-- ‰ªªÂä°ÂàóË°® -->
      <div class="task-list" id="taskList">
        <div class="empty-state">
          <div class="empty-state-icon">‚úÖ</div>
          <p>ÊöÇÊó†ÂæÖÂ≠¶‰π†‰ªªÂä°</p>
        </div>
      </div>

      <!-- Â≠¶‰π†ÁªüËÆ°ÂàóË°® -->
      <div class="stats-list" id="statsList" style="display: none;">
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <p>ÊöÇÊó†Â≠¶‰π†ËÆ∞ÂΩï</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Ê∑ªÂä†‰π¶Á±çÊ®°ÊÄÅÊ°Ü -->
  <div class="modal" id="addBookModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìñ Ê∑ªÂä†Êñ∞‰π¶Á±ç</h2>
      </div>
      <div class="form-group">
        <label>‰π¶Á±çÂêçÁß∞</label>
        <input type="text" id="bookName" placeholder="‰æãÂ¶ÇÔºöÊ∞ëÊ≥ï‰∏ä Á¨¨‰∏ÄÁ´†">
      </div>

      <div class="form-group">
        <label>ÊâÄÂ±ûÊñá‰ª∂Â§πÔºàÂèØÈÄâÔºâ</label>
        <select id="bookFolder">
          <option value="">Êó†ÔºàÊ†πÁõÆÂΩïÔºâ</option>
        </select>
        <div class="help-text">ÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂Â§πÊù•ÁªÑÁªá‰π¶Á±ç</div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>ÁõÆÊ†áÂ≠¶‰π†Ê¨°Êï∞</label>
          <input type="number" id="targetRounds" value="8" min="1">
        </div>
        <div class="form-group">
          <label>Êà™Ê≠¢Êó•Êúü</label>
          <input type="date" id="deadlineDate">
          <div class="help-text">ÈÄâÊã©ÂÆåÊàêÂ≠¶‰π†ÁöÑÊà™Ê≠¢Êó•Êúü</div>
        </div>
      </div>

      <div id="planPreview" class="info-box" style="display: none;">
        <strong>üìÖ Â≠¶‰π†ËÆ°ÂàíÈ¢ÑËßàÔºö</strong><br>
        <span id="planPreviewText"></span>
      </div>

      <div class="form-group">
        <label>ÂÜÖÂÆπÊ†ºÂºè</label>
        <div class="format-tabs">
          <div class="format-tab active" onclick="app.switchFormat('text')">üìù Á∫ØÊñáÊú¨</div>
          <div class="format-tab" onclick="app.switchFormat('markdown')">üìÑ Markdown</div>
        </div>
      </div>

      <div class="form-group">
        <label>‰π¶Á±çÂÜÖÂÆπ</label>
        <div style="margin-bottom: 10px;">
          <input type="file" id="fileInput" accept=".txt,.md,.pdf" style="display: none;" onchange="app.handleFileUpload(event)">
          <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">üìÅ ÂØºÂÖ•Êñá‰ª∂ (TXT/MD/PDF)</button>
          <span id="fileName" style="margin-left: 10px; font-size: 12px; color: #666;"></span>
        </div>
        <textarea id="bookContent" placeholder="Á≤òË¥¥‰π¶Á±çÂÜÖÂÆπÔºåÊàñÁÇπÂáª‰∏äÊñπÊåâÈíÆÂØºÂÖ•Êñá‰ª∂..."></textarea>
        <div class="help-text" id="formatHint">ÊîØÊåÅÁ∫ØÊñáÊú¨Ê†ºÂºè</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.hideAddBookModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="app.addBook()">Ê∑ªÂä†</button>
      </div>
    </div>
  </div>

  <!-- ÁºñËæë‰π¶Á±çËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
  <div class="modal" id="editBookModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öôÔ∏è ‰π¶Á±çËÆæÁΩÆ</h2>
      </div>
      <div class="form-group">
        <label>‰π¶Á±çÂêçÁß∞</label>
        <input type="text" id="editBookName">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>ÁõÆÊ†áÂ≠¶‰π†Ê¨°Êï∞</label>
          <input type="number" id="editTargetRounds" min="1">
        </div>
        <div class="form-group">
          <label>Êà™Ê≠¢Êó•Êúü</label>
          <input type="date" id="editDeadlineDate">
        </div>
      </div>

      <div id="editPlanPreview" class="info-box" style="display: none;">
        <strong>üìÖ Â≠¶‰π†ËÆ°ÂàíÈ¢ÑËßàÔºö</strong><br>
        <span id="editPlanPreviewText"></span>
      </div>

      <div id="editCurrentStats" class="info-box" style="display: none;">
        <strong>üìä ÂΩìÂâçÂ≠¶‰π†ÁªüËÆ°Ôºö</strong><br>
        <span id="editCurrentStatsText"></span>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.showEditContentModal()">üìù ÁºñËæëÂÜÖÂÆπ</button>
        <button class="btn btn-danger" onclick="app.deleteBook()">üóëÔ∏è Âà†Èô§‰π¶Á±ç</button>
        <div style="flex: 1"></div>
        <button class="btn btn-secondary" onclick="app.hideEditBookModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="app.saveBookSettings()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- ÁºñËæë‰π¶Á±çÂÜÖÂÆπÊ®°ÊÄÅÊ°Ü -->
  <div class="modal" id="editContentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìù ÁºñËæë‰π¶Á±çÂÜÖÂÆπ</h2>
        <p style="font-size: 13px; color: #666; margin-top: 5px;">
          ‚ö†Ô∏è ‰øÆÊîπÂÜÖÂÆπÂêéÔºåÁé∞ÊúâÁöÑÂ≠¶‰π†Âå∫ÂùóÂ∞ÜË¢´Ê∏ÖÈô§
        </p>
      </div>
      
      <div class="form-group">
        <label>ÂÜÖÂÆπÊ†ºÂºè</label>
        <div class="format-tabs">
          <div class="format-tab active" id="editFormatText" onclick="app.switchEditFormat('text')">üìù Á∫ØÊñáÊú¨</div>
          <div class="format-tab" id="editFormatMarkdown" onclick="app.switchEditFormat('markdown')">üìÑ Markdown</div>
        </div>
      </div>

      <div class="form-group">
        <label>‰π¶Á±çÂÜÖÂÆπ</label>
        <textarea id="editBookContent" style="min-height: 400px;"></textarea>
        <div class="help-text">
          ÂèØ‰ª•Áõ¥Êé•ÁºñËæë„ÄÅÂà†Èô§ÊàñÊ∑ªÂä†Êñ∞ÂÜÖÂÆπ
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.hideEditContentModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="app.saveBookContent()">‰øùÂ≠òÂÜÖÂÆπ</button>
      </div>
    </div>
  </div>

  <!-- ÂêåÊ≠•Êï∞ÊçÆÊ®°ÊÄÅÊ°Ü -->
  <div class="modal" id="syncModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîÑ Ë∑®ËÆæÂ§áÂêåÊ≠•</h2>
        <p style="font-size: 13px; color: #666; margin-top: 5px;">
          ÈÄâÊã©‰∏ÄÁßçÊñπÂºèÂú®Â§ö‰∏™ËÆæÂ§áÈó¥ÂêåÊ≠•Â≠¶‰π†Êï∞ÊçÆ
        </p>
      </div>

      <div class="sync-options">
        <!-- ÈÄâÈ°π1: Ââ™Ë¥¥ÊùøÂêåÊ≠• -->
        <div class="sync-option-card">
          <div class="sync-option-header">
            <span class="sync-option-icon">üìã</span>
            <h3>Ââ™Ë¥¥ÊùøÂêåÊ≠•</h3>
            <span class="sync-option-badge recommended">Êé®Ëçê</span>
          </div>
          <p class="sync-option-desc">Â§çÂà∂Êï∞ÊçÆÂà∞Ââ™Ë¥¥ÊùøÔºåÂú®ÂÖ∂‰ªñËÆæÂ§áÁ≤òË¥¥ÂØºÂÖ•</p>
          <div class="sync-option-actions">
            <button class="btn btn-primary" onclick="app.copyToClipboard(true)">üìã Â§çÂà∂ÂéãÁº©Êï∞ÊçÆÔºàÊé®ËçêÔºâ</button>
            <button class="btn btn-secondary" onclick="app.pasteFromClipboard()">üì• ‰ªéÂâ™Ë¥¥ÊùøÂØºÂÖ•</button>
          </div>
          <div id="syncStats" class="help-text" style="margin-top: 8px;"></div>
          <div class="help-text">üí° ÂéãÁº©ÂêéÊï∞ÊçÆÈáèÂáèÂ∞ë70-80%ÔºåÊõ¥ÂÆπÊòìÂàÜ‰∫´</div>
        </div>

        <!-- ÈÄâÈ°π2: ‰∫åÁª¥Á†ÅÂêåÊ≠• -->
        <div class="sync-option-card">
          <div class="sync-option-header">
            <span class="sync-option-icon">üì±</span>
            <h3>‰∫åÁª¥Á†ÅÂêåÊ≠•</h3>
          </div>
          <p class="sync-option-desc">ÁîüÊàê‰∫åÁª¥Á†ÅÔºåÊâãÊú∫Êâ´ÊèèÂç≥ÂèØÂØºÂÖ•</p>
          <div class="sync-option-actions">
            <button class="btn btn-primary" onclick="app.generateQRCode()">üì± ÁîüÊàê‰∫åÁª¥Á†Å</button>
          </div>
          <div id="qrcodeContainer" style="display: none; text-align: center; margin-top: 15px;">
            <div id="qrcodeImage"></div>
            <div class="help-text" style="margin-top: 10px;">Áî®ÊâãÊú∫Êâ´ÊèèÊ≠§‰∫åÁª¥Á†ÅÊâìÂºÄÂêåÊ≠•È°µÈù¢</div>
          </div>
          <div class="help-text">üí° ÊúÄÊñπ‰æøÔºåÊâãÊú∫Êâ´Á†ÅÁõ¥Êé•ÂØºÂÖ•</div>
        </div>

        <!-- ÈÄâÈ°π3: Êñá‰ª∂ÂêåÊ≠• -->
        <div class="sync-option-card">
          <div class="sync-option-header">
            <span class="sync-option-icon">üíæ</span>
            <h3>Êñá‰ª∂ÂêåÊ≠•</h3>
          </div>
          <p class="sync-option-desc">‰∏ãËΩΩÂ§á‰ªΩÊñá‰ª∂ÔºåÈÄöËøá‰∫ëÁõòÊàñÊñá‰ª∂‰º†ËæìÂêåÊ≠•</p>
          <div class="sync-option-actions">
            <button class="btn btn-success" onclick="app.exportData()">üíæ ‰∏ãËΩΩÂ§á‰ªΩÊñá‰ª∂</button>
            <button class="btn btn-secondary" onclick="app.showImportFileDialog()">üìÅ ÂØºÂÖ•Â§á‰ªΩÊñá‰ª∂</button>
          </div>
          <div class="help-text">üí° ÈÄÇÂêàÂÆöÊúüÂ§á‰ªΩÔºåÂèØ‰øùÂ≠òÂà∞ÂùöÊûú‰∫ë/ÁΩëÁõò</div>
        </div>

        <!-- ÈÄâÈ°π4: Ëá™Âä®ÂêåÊ≠•ËØ¥Êòé -->
        <div class="info-box">
          <strong>üîî ÂêåÊ≠•Âª∫ËÆÆÔºö</strong><br>
          <span id="syncRecommendation">
            ‚Ä¢ üìã Êï∞ÊçÆÈáèÂ∞èÔºà<10KBÔºâÔºöÊé®ËçêÂâ™Ë¥¥ÊùøÂêåÊ≠•<br>
            ‚Ä¢ üíæ Êï∞ÊçÆÈáèÂ§ßÔºà>10KBÔºâÔºöÊé®ËçêÊñá‰ª∂ÂêåÊ≠•<br>
          </span>
          <strong>‰ΩøÁî®ÊñπÊ≥ïÔºö</strong><br>
          1. ÁÇπÂáª"Â§çÂà∂ÂéãÁº©Êï∞ÊçÆ"<br>
          2. ÂèëÈÄÅÁªôËá™Â∑±ÔºàÂæÆ‰ø°Êñá‰ª∂‰º†ËæìÂä©Êâã/QQ/ÈÇÆ‰ª∂Ôºâ<br>
          3. ÂÖ∂‰ªñËÆæÂ§áÊâìÂºÄÈ°µÈù¢ÔºåÁÇπÂáª"‰ªéÂâ™Ë¥¥ÊùøÂØºÂÖ•"<br>
          4. Á≤òË¥¥Êï∞ÊçÆÂç≥ÂèØÂÆåÊàêÂêåÊ≠•
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.hideSyncModal()">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>

  <!-- ÂàõÂª∫Êñá‰ª∂Â§πÊ®°ÊÄÅÊ°Ü -->
  <div class="modal" id="createFolderModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2>üìÅ ÂàõÂª∫Êñá‰ª∂Â§π</h2>
      </div>
      <div class="form-group">
        <label>Êñá‰ª∂Â§πÂêçÁß∞</label>
        <input type="text" id="folderName" placeholder="‰æãÂ¶ÇÔºöËÄÉÁ†îËµÑÊñô„ÄÅ‰∏ì‰∏öËØæ„ÄÅÂÖ¨ÂÖ±ËØæ">
      </div>
      <div class="form-group">
        <label>Êñá‰ª∂Â§πÂõæÊ†áÔºàÂèØÈÄâÔºâ</label>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="folder-icon-btn" onclick="app.selectFolderIcon('üìÅ')">üìÅ</button>
          <button class="folder-icon-btn" onclick="app.selectFolderIcon('üìö')">üìö</button>
          <button class="folder-icon-btn" onclick="app.selectFolderIcon('üìñ')">üìñ</button>
          <button class="folder-icon-btn" onclick="app.selectFolderIcon('üìù')">üìù</button>
          <button class="folder-icon-btn" onclick="app.selectFolderIcon('üéì')">üéì</button>
          <button class="folder-icon-btn" onclick="app.selectFolderIcon('üíº')">üíº</button>
          <button class="folder-icon-btn" onclick="app.selectFolderIcon('üî¨')">üî¨</button>
          <button class="folder-icon-btn" onclick="app.selectFolderIcon('‚öñÔ∏è')">‚öñÔ∏è</button>
        </div>
        <input type="hidden" id="folderIcon" value="üìÅ">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.hideCreateFolderModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="app.createFolder()">ÂàõÂª∫</button>
      </div>
    </div>
  </div>

  <!-- ÊâπÈáèÂØºÂÖ•‰π¶Á±çÊ®°ÊÄÅÊ°Ü -->
  <div class="modal" id="batchImportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìö ÊâπÈáèÂØºÂÖ•‰π¶Á±ç</h2>
        <p style="font-size: 13px; color: #666; margin-top: 5px;">
          ‰∏ÄÊ¨°ÊÄßÂØºÂÖ•Â§ö‰∏™Êñá‰ª∂ÔºàÊîØÊåÅTXT/MD/PDFÔºâ
        </p>
      </div>

      <div class="info-box">
        <strong>üí° ‰ΩøÁî®ÊèêÁ§∫Ôºö</strong><br>
        ‚Ä¢ ÊîØÊåÅÂêåÊó∂ÈÄâÊã©Â§ö‰∏™Êñá‰ª∂ÔºàÊåâ‰ΩèCtrl/CmdÂ§öÈÄâÔºâ<br>
        ‚Ä¢ ÊîØÊåÅÁöÑÊ†ºÂºèÔºö.txt„ÄÅ.md„ÄÅ.pdf<br>
        ‚Ä¢ Êñá‰ª∂ÂêçÂ∞ÜËá™Âä®‰Ωú‰∏∫‰π¶Á±çÂêçÁß∞<br>
        ‚Ä¢ ÂèØ‰ª•Áªü‰∏ÄËÆæÁΩÆÂ≠¶‰π†ÁõÆÊ†áÂíåÊà™Ê≠¢Êó•Êúü
      </div>

      <div class="form-group">
        <label>ÂØºÂÖ•Âà∞Êñá‰ª∂Â§πÔºàÂèØÈÄâÔºâ</label>
        <select id="batchFolder">
          <option value="">Êó†ÔºàÊ†πÁõÆÂΩïÔºâ</option>
        </select>
        <div class="help-text">ÊâÄÊúâ‰π¶Á±çÂ∞ÜÂØºÂÖ•Âà∞Ê≠§Êñá‰ª∂Â§π</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>ÁõÆÊ†áÂ≠¶‰π†Ê¨°Êï∞ÔºàÁªü‰∏ÄËÆæÁΩÆÔºâ</label>
          <input type="number" id="batchTargetRounds" value="8" min="1">
        </div>
        <div class="form-group">
          <label>Êà™Ê≠¢Êó•ÊúüÔºàÁªü‰∏ÄËÆæÁΩÆÔºâ</label>
          <input type="date" id="batchDeadlineDate">
        </div>
      </div>

      <div id="batchPlanPreview" class="info-box" style="display: none;">
        <strong>üìÖ Â≠¶‰π†ËÆ°ÂàíÈ¢ÑËßàÔºö</strong><br>
        <span id="batchPlanPreviewText"></span>
      </div>

      <div class="form-group">
        <label>ÈÄâÊã©Êñá‰ª∂</label>
        <input type="file" id="batchFileInput" accept=".txt,.md,.pdf" multiple style="padding: 8px;">
        <div class="help-text">Êåâ‰ΩèCtrl/CmdÂèØÈÄâÊã©Â§ö‰∏™Êñá‰ª∂</div>
      </div>

      <div id="batchFileList" style="display: none; margin-top: 15px;">
        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Â∑≤ÈÄâÊã©ÁöÑÊñá‰ª∂Ôºö</label>
        <div id="batchFileListContent" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 6px;">
        </div>
      </div>

      <div id="batchImportProgress" style="display: none; margin-top: 15px;">
        <div class="info-box">
          <strong>üìä ÂØºÂÖ•ËøõÂ∫¶Ôºö</strong><br>
          <div id="batchProgressText" style="margin-top: 8px;"></div>
          <div class="progress-bar-container" style="margin-top: 10px;">
            <div class="progress-bar" id="batchProgressBar" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.hideBatchImportModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="batchImportBtn" onclick="app.processBatchImport()">ÂºÄÂßãÂØºÂÖ•</button>
      </div>
    </div>
  </div>

  <!-- ÂØºÂá∫AnkiÂç°ÁâáÊ®°ÊÄÅÊ°Ü -->
  <div class="modal" id="ankiExportModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>üìá ÂØºÂá∫AnkiÂç°Áâá</h2>
        <p style="font-size: 13px; color: #666; margin-top: 5px;">
          Â∞ÜÂ≠¶‰π†Âå∫ÂùóÂØºÂá∫‰∏∫AnkiÂèØÂØºÂÖ•ÁöÑtxtÊ†ºÂºè
        </p>
      </div>

      <div class="info-box">
        <strong>üí° ‰ΩøÁî®ËØ¥ÊòéÔºö</strong><br>
        1. ÈÄâÊã©ÂØºÂá∫ËåÉÂõ¥ÂíåÂç°ÁâáÁ±ªÂûã<br>
        2. ÁÇπÂáª"ÁîüÊàêAnkiÂç°Áâá"‰∏ãËΩΩtxtÊñá‰ª∂<br>
        3. Âú®Anki‰∏≠ÔºöÊñá‰ª∂ ‚Üí ÂØºÂÖ• ‚Üí ÈÄâÊã©‰∏ãËΩΩÁöÑtxtÊñá‰ª∂<br>
        4. ËÆæÁΩÆÂàÜÈöîÁ¨¶‰∏∫"Âà∂Ë°®Á¨¶(Tab)"<br>
        5. ÂÆåÊàêÂØºÂÖ•
      </div>

      <div class="form-group">
        <label>ÈÄâÊã©‰π¶Á±ç</label>
        <select id="ankiBookSelect">
          <option value="current">ÂΩìÂâç‰π¶Á±ç</option>
          <option value="all">ÊâÄÊúâ‰π¶Á±ç</option>
        </select>
      </div>

      <div class="form-group">
        <label>ÂØºÂá∫ËåÉÂõ¥</label>
        <select id="ankiRangeSelect">
          <option value="all">ÊâÄÊúâÂ≠¶‰π†Âå∫Âùó</option>
          <option value="important">‰ªÖÈáçÁÇπÂå∫ÂùóÔºà‚≠êÊ†áËÆ∞Ôºâ</option>
        </select>
      </div>

      <div class="form-group">
        <label>Âç°ÁâáÁ±ªÂûã</label>
        <select id="ankiCardType">
          <option value="basic">Âü∫Á°ÄÂç°ÁâáÔºàÊ≠£Èù¢/ËÉåÈù¢Ôºâ</option>
          <option value="cloze">Â°´Á©∫Âç°Áâá</option>
        </select>
        <div class="help-text" id="ankiCardTypeHint">
          Âü∫Á°ÄÂç°ÁâáÔºö‰π¶Á±çÂêç+ÂÜÖÂÆπÁ¨¨‰∏ÄË°å ‚Üí ÂÆåÊï¥Âå∫ÂùóÂÜÖÂÆπ
        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="ankiIncludeTags" checked style="width: auto; margin-right: 5px;">
          ÂåÖÂê´Ê†áÁ≠æÔºà‰π¶Á±çÂêç„ÄÅÂ≠¶‰π†Ê¨°Êï∞Ôºâ
        </label>
      </div>

      <div id="ankiPreview" class="info-box" style="display: none; margin-top: 15px;">
        <strong>üìä È¢ÑËßàÔºö</strong><br>
        <span id="ankiPreviewText"></span>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.hideAnkiExportModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="app.exportAnkiCards()">üìá ÁîüÊàêAnkiÂç°Áâá</button>
      </div>
    </div>
  </div>

  <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
  <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="app.handleImportFile(event)">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
  <script>
    // ÈÖçÁΩÆ PDF.js
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // ÈÖçÁΩÆ marked
    if (typeof marked !== 'undefined') {
      marked.setOptions({
        gfm: true, // ÂêØÁî®GitHubÈ£éÊ†ºÁöÑMarkdown
        breaks: true, // Â∞ÜÂçï‰∏™Êç¢Ë°åÁ¨¶ËΩ¨Êç¢‰∏∫<br>
        tables: true // ÂêØÁî®Ë°®Ê†ºÊîØÊåÅ
      });
    }

    const app = {
      data: {
        books: [],
        folders: [],
        currentBookId: null,
        studyStats: {
          totalStudyTime: 0,
          studyHistory: []
        }
      },
      state: {
        selectMode: false,
        selectedLines: [],
        editingBookId: null,
        currentFormat: 'text',
        editFormat: 'text',
        currentTaskTab: 'tasks',
        collapsedFolders: new Set()
      },
      colors: [
        '#FFE5E5', '#E5F5FF', '#FFF5E5', 
        '#E5FFE5', '#F5E5FF', '#FFE5F5',
        '#FFF0E5', '#E5FFFF', '#F0FFE5'
      ],

      init() {
        this.loadData();
        this.renderBookList();
        this.updateGlobalStats();
        this.updateTaskList();
        this.setupEventListeners();
        
        // Ê£ÄÊü•URLÂèÇÊï∞‰∏≠ÊòØÂê¶ÊúâÂØºÂÖ•Êï∞ÊçÆ
        this.checkUrlImport();
        
        setInterval(() => {
          this.updateTaskList();
          this.updateGlobalStats();
        }, 60000);

        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 30);
        document.getElementById('deadlineDate').valueAsDate = defaultDate;
      },

      checkUrlImport() {
        const urlParams = new URLSearchParams(window.location.search);
        const importData = urlParams.get('import');
        
        if (importData) {
          try {
            const dataStr = atob(decodeURIComponent(importData));
            if (confirm('Ê£ÄÊµãÂà∞ÂêåÊ≠•Êï∞ÊçÆÔºåÊòØÂê¶ÂØºÂÖ•Ôºü')) {
              this.importDataFromString(dataStr);
              // Ê∏ÖÈô§URLÂèÇÊï∞
              window.history.replaceState({}, document.title, window.location.pathname);
            }
          } catch (error) {
            console.error('URLÂØºÂÖ•Â§±Ë¥•:', error);
          }
        }
      },

      setupEventListeners() {
        ['targetRounds', 'deadlineDate'].forEach(id => {
          document.getElementById(id)?.addEventListener('input', () => this.updatePlanPreview());
        });

        ['editTargetRounds', 'editDeadlineDate'].forEach(id => {
          document.getElementById(id)?.addEventListener('input', () => this.updateEditPlanPreview());
        });

        // ÊâπÈáèÂØºÂÖ•‰∫ã‰ª∂ÁõëÂê¨
        ['batchTargetRounds', 'batchDeadlineDate'].forEach(id => {
          document.getElementById(id)?.addEventListener('input', () => this.updateBatchPlanPreview());
        });

        document.getElementById('batchFileInput')?.addEventListener('change', (e) => this.handleBatchFileSelection(e));

        // AnkiÂØºÂá∫‰∫ã‰ª∂ÁõëÂê¨
        ['ankiBookSelect', 'ankiRangeSelect', 'ankiCardType'].forEach(id => {
          document.getElementById(id)?.addEventListener('change', () => this.updateAnkiPreview());
        });
      },

      loadData() {
        const saved = localStorage.getItem('studySystemData');
        if (saved) {
          this.data = JSON.parse(saved);
          if (!this.data.studyStats) {
            this.data.studyStats = {
              totalStudyTime: 0,
              studyHistory: []
            };
          }
          if (!this.data.folders) {
            this.data.folders = [];
          }
          this.data.books.forEach(book => {
            if (!book.blocks) book.blocks = [];
            if (!book.format) book.format = 'text';
            if (!book.folderId) book.folderId = null;
          });
        }
      },

      saveData() {
        localStorage.setItem('studySystemData', JSON.stringify(this.data));
      },

      // ========== Ê†ºÂºèÂàáÊç¢ÂäüËÉΩ ==========
      switchFormat(format) {
        this.state.currentFormat = format;
        document.querySelectorAll('.format-tabs .format-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // ÈÄöËøáÊ†ºÂºèÂêçÁß∞ÊâæÂà∞ÂØπÂ∫îÁöÑÊ†áÁ≠æÈ°µÂπ∂ÊøÄÊ¥ª
        const tabs = document.querySelectorAll('.format-tabs .format-tab');
        tabs.forEach(tab => {
          if ((format === 'markdown' && tab.textContent.includes('Markdown')) ||
              (format === 'text' && tab.textContent.includes('Á∫ØÊñáÊú¨'))) {
            tab.classList.add('active');
          }
        });
        
        if (format === 'markdown') {
          document.getElementById('formatHint').textContent = 'ÊîØÊåÅMarkdownÊ†ºÂºèÔºàÊ†áÈ¢ò„ÄÅÂàóË°®„ÄÅ‰ª£Á†ÅÂùóÁ≠âÔºâ';
        } else {
          document.getElementById('formatHint').textContent = 'ÊîØÊåÅÁ∫ØÊñáÊú¨Ê†ºÂºè';
        }
      },

      switchEditFormat(format) {
        this.state.editFormat = format;
        document.getElementById('editFormatText').classList.remove('active');
        document.getElementById('editFormatMarkdown').classList.remove('active');
        
        if (format === 'markdown') {
          document.getElementById('editFormatMarkdown').classList.add('active');
        } else {
          document.getElementById('editFormatText').classList.add('active');
        }
      },

      // ========== Êñá‰ª∂ÂØºÂÖ•ÂäüËÉΩ ==========
      async handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        document.getElementById('fileName').textContent = `Â∑≤ÈÄâÊã©: ${file.name}`;
        
        try {
          let content = '';
          const fileType = file.name.split('.').pop().toLowerCase();

          if (fileType === 'pdf') {
            content = await this.extractPDFText(file);
            this.switchFormat('text');
          } else if (fileType === 'md') {
            content = await this.readTextFile(file);
            this.switchFormat('markdown');
          } else {
            content = await this.readTextFile(file);
            this.switchFormat('text');
          }

          document.getElementById('bookContent').value = content;
          
          if (!document.getElementById('bookName').value) {
            const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
            document.getElementById('bookName').value = nameWithoutExt;
          }
        } catch (error) {
          alert('‚ùå Êñá‰ª∂ËØªÂèñÂ§±Ë¥•: ' + error.message);
        }
      },

      readTextFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            let text = e.target.result;
            // Ê∏ÖÁêÜÂèØËÉΩÁöÑBOMÊ†áËÆ∞
            text = text.replace(/^\uFEFF/, '');
            resolve(text);
          };
          reader.onerror = (e) => reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
          reader.readAsText(file, 'UTF-8');
        });
      },

      async extractPDFText(file) {
        if (typeof pdfjsLib === 'undefined') {
          throw new Error('PDFËß£ÊûêÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        }

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n\n';
        }

        return fullText.trim();
      },

      // ========== ÂÖ®Â±ÄÁªüËÆ°ÂäüËÉΩ ==========
      updateGlobalStats() {
        const stats = this.calculateGlobalStats();
        
        document.getElementById('totalBooks').textContent = stats.totalBooks;
        document.getElementById('totalBlocks').textContent = stats.totalBlocks;
        document.getElementById('studiedBlocks').textContent = stats.studiedBlocks;
        document.getElementById('totalTargetStudies').textContent = stats.totalTargetStudies;
        document.getElementById('completedStudies').textContent = stats.completedStudies;
        
        const speedEl = document.getElementById('avgSpeed');
        if (stats.avgStudiesPerDay > 0) {
          speedEl.textContent = `${stats.avgStudiesPerDay.toFixed(1)}Ê¨°/Â§©`;
          speedEl.className = 'stats-value success';
        } else {
          speedEl.textContent = 'ÊöÇÊó†Êï∞ÊçÆ';
          speedEl.className = 'stats-value';
        }

        const probEl = document.getElementById('completionProb');
        if (stats.completionProbability !== null) {
          const prob = stats.completionProbability;
          probEl.textContent = `${prob.toFixed(0)}%`;
          if (prob >= 80) {
            probEl.className = 'stats-value success';
          } else if (prob >= 50) {
            probEl.className = 'stats-value warning';
          } else {
            probEl.className = 'stats-value danger';
          }
        } else {
          probEl.textContent = 'ÊöÇÊó†ÁõÆÊ†á';
          probEl.className = 'stats-value';
        }

        const progressPercent = stats.totalTargetStudies > 0 
          ? (stats.completedStudies / stats.totalTargetStudies * 100) 
          : 0;
        document.getElementById('overallProgress').style.width = `${Math.min(progressPercent, 100)}%`;
      },

      calculateGlobalStats() {
        const books = this.data.books;
        const now = Date.now();
        
        let totalBooks = books.length;
        let totalBlocks = 0;
        let studiedBlocks = 0;
        let totalTargetStudies = 0;
        let completedStudies = 0;
        let totalRemainingStudies = 0;
        let minDeadline = null;
        
        books.forEach(book => {
          totalBlocks += book.blocks.length;
          
          book.blocks.forEach(block => {
            if (block.studyRecords && block.studyRecords.length > 0) {
              studiedBlocks++;
              completedStudies += block.studyRecords.length;
            }
            
            if (book.targetRounds) {
              totalTargetStudies += book.targetRounds;
              const remaining = Math.max(0, book.targetRounds - (block.studyRecords?.length || 0));
              totalRemainingStudies += remaining;
            }
          });

          if (book.deadline) {
            if (!minDeadline || book.deadline < minDeadline) {
              minDeadline = book.deadline;
            }
          }
        });

        const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
        let recentStudies = 0;
        
        books.forEach(book => {
          book.blocks.forEach(block => {
            if (block.studyRecords) {
              recentStudies += block.studyRecords.filter(r => r.timestamp > sevenDaysAgo).length;
            }
          });
        });
        
        const avgStudiesPerDay = recentStudies / 7;

        let completionProbability = null;
        if (minDeadline && totalRemainingStudies > 0 && avgStudiesPerDay > 0) {
          const daysLeft = Math.max(0, (minDeadline - now) / (1000 * 60 * 60 * 24));
          const projectedStudies = avgStudiesPerDay * daysLeft;
          completionProbability = Math.min(100, (projectedStudies / totalRemainingStudies) * 100);
        } else if (totalRemainingStudies === 0) {
          completionProbability = 100;
        }

        return {
          totalBooks,
          totalBlocks,
          studiedBlocks,
          totalTargetStudies,
          completedStudies,
          avgStudiesPerDay,
          completionProbability,
          totalRemainingStudies,
          daysLeft: minDeadline ? Math.max(0, (minDeadline - now) / (1000 * 60 * 60 * 24)) : null
        };
      },

      // ========== Êñá‰ª∂Â§πÁÆ°ÁêÜÂäüËÉΩ ==========
      showCreateFolderModal() {
        document.getElementById('createFolderModal').classList.add('show');
        document.getElementById('folderName').value = '';
        document.getElementById('folderIcon').value = 'üìÅ';
        // ÈáçÁΩÆÈÄâ‰∏≠Áä∂ÊÄÅ
        document.querySelectorAll('.folder-icon-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        document.querySelector('.folder-icon-btn').classList.add('selected');
      },

      hideCreateFolderModal() {
        document.getElementById('createFolderModal').classList.remove('show');
      },

      selectFolderIcon(icon) {
        document.getElementById('folderIcon').value = icon;
        document.querySelectorAll('.folder-icon-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        event.target.classList.add('selected');
      },

      createFolder() {
        const name = document.getElementById('folderName').value.trim();
        const icon = document.getElementById('folderIcon').value;

        if (!name) {
          alert('ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞');
          return;
        }

        const newFolder = {
          id: 'folder_' + Date.now(),
          name: name,
          icon: icon,
          createdAt: Date.now()
        };

        this.data.folders.push(newFolder);
        this.saveData();
        this.hideCreateFolderModal();
        this.renderBookList();
        alert('‚úÖ Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäüÔºÅ');
      },

      deleteFolder(folderId) {
        const folder = this.data.folders.find(f => f.id === folderId);
        if (!folder) return;

        const booksInFolder = this.data.books.filter(b => b.folderId === folderId);
        
        let message = `Á°ÆÂÆöË¶ÅÂà†Èô§Êñá‰ª∂Â§π"${folder.name}"ÂêóÔºü`;
        if (booksInFolder.length > 0) {
          message += `\n\nÊñá‰ª∂Â§π‰∏≠Êúâ ${booksInFolder.length} Êú¨‰π¶Á±çÔºåÂÆÉ‰ª¨Â∞ÜË¢´ÁßªÂä®Âà∞Ê†πÁõÆÂΩï„ÄÇ`;
        }

        if (!confirm(message)) {
          return;
        }

        // Â∞ÜÊñá‰ª∂Â§π‰∏≠ÁöÑ‰π¶Á±çÁßªÂà∞Ê†πÁõÆÂΩï
        booksInFolder.forEach(book => {
          book.folderId = null;
        });

        // Âà†Èô§Êñá‰ª∂Â§π
        const index = this.data.folders.findIndex(f => f.id === folderId);
        if (index > -1) {
          this.data.folders.splice(index, 1);
        }

        this.saveData();
        this.renderBookList();
        alert('‚úÖ Êñá‰ª∂Â§πÂ∑≤Âà†Èô§');
      },

      toggleFolder(folderId) {
        if (this.state.collapsedFolders.has(folderId)) {
          this.state.collapsedFolders.delete(folderId);
        } else {
          this.state.collapsedFolders.add(folderId);
        }
        this.renderBookList();
      },

      movBookToFolder(bookId, folderId) {
        const book = this.data.books.find(b => b.id === bookId);
        if (!book) return;

        book.folderId = folderId || null;
        this.saveData();
        this.renderBookList();
      },

      updateFolderSelects() {
        // Êõ¥Êñ∞ÊâÄÊúâÊñá‰ª∂Â§πÈÄâÊã©‰∏ãÊãâÊ°Ü
        const folderOptions = this.data.folders.map(folder => 
          `<option value="${folder.id}">${folder.icon} ${folder.name}</option>`
        ).join('');

        ['bookFolder', 'batchFolder'].forEach(id => {
          const select = document.getElementById(id);
          if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Êó†ÔºàÊ†πÁõÆÂΩïÔºâ</option>' + folderOptions;
            select.value = currentValue;
          }
        });
      },

      // ========== ‰π¶Á±çÁÆ°ÁêÜÂäüËÉΩ ==========
      showAddBookModal() {
        document.getElementById('addBookModal').classList.add('show');
        document.getElementById('bookName').value = '';
        document.getElementById('bookContent').value = '';
        document.getElementById('targetRounds').value = '8';
        document.getElementById('fileName').textContent = '';
        document.getElementById('fileInput').value = '';
        
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 50);
        document.getElementById('deadlineDate').valueAsDate = defaultDate;
        
        this.state.currentFormat = 'text';
        this.updateFolderSelects();
        this.updatePlanPreview();
      },

      hideAddBookModal() {
        document.getElementById('addBookModal').classList.remove('show');
      },

      updatePlanPreview() {
        const rounds = parseInt(document.getElementById('targetRounds').value) || 8;
        const deadlineInput = document.getElementById('deadlineDate').value;
        
        if (!deadlineInput) {
          document.getElementById('planPreview').style.display = 'none';
          return;
        }

        const deadline = new Date(deadlineInput).getTime();
        const now = Date.now();
        const days = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
        
        if (days <= 0) {
          document.getElementById('planPreview').className = 'info-box danger';
          document.getElementById('planPreviewText').innerHTML = 
            '‚ö†Ô∏è Êà™Ê≠¢Êó•ÊúüÂ∑≤ËøáÊúüÔºåËØ∑ÈÄâÊã©Êú™Êù•ÁöÑÊó•Êúü';
          document.getElementById('planPreview').style.display = 'block';
          return;
        }

        const avgInterval = (days / rounds).toFixed(1);
        
        let className = 'info-box';
        let message = `Â∞ÜÂú® <strong>${days}Â§©</strong> ÂÜÖÂÆåÊàê <strong>${rounds}Ê¨°</strong> Â≠¶‰π†<br>`;
        message += `Âπ≥ÂùáÊØè <strong>${avgInterval}Â§©</strong> Â≠¶‰π†‰∏ÄÊ¨°<br>`;
        message += `Êà™Ê≠¢Êó•ÊúüÔºö<strong>${new Date(deadline).toLocaleDateString('zh-CN')}</strong>`;
        
        if (parseFloat(avgInterval) < 2) {
          className = 'info-box warning';
          message += '<br>‚ö†Ô∏è Â≠¶‰π†ËäÇÂ•èËæÉÁ¥ßÂº†ÔºåÂª∫ËÆÆÈÄÇÂΩìË∞ÉÊï¥';
        } else if (parseFloat(avgInterval) > 10) {
          className = 'info-box success';
          message += '<br>‚úÖ Â≠¶‰π†ËäÇÂ•èÂÆΩÊùæÔºåÂèØ‰ª•‰ªéÂÆπÂÆâÊéí';
        } else {
          className = 'info-box';
          message += '<br>‚úÖ Â≠¶‰π†ËäÇÂ•èÈÄÇ‰∏≠';
        }

        document.getElementById('planPreview').className = className;
        document.getElementById('planPreviewText').innerHTML = message;
        document.getElementById('planPreview').style.display = 'block';
      },

      addBook() {
        const name = document.getElementById('bookName').value.trim();
        const content = document.getElementById('bookContent').value.trim();
        const targetRounds = parseInt(document.getElementById('targetRounds').value) || 8;
        const deadlineInput = document.getElementById('deadlineDate').value;
        const folderId = document.getElementById('bookFolder').value || null;

        if (!name) {
          alert('ËØ∑ËæìÂÖ•‰π¶Á±çÂêçÁß∞');
          return;
        }

        if (!content) {
          alert('ËØ∑ËæìÂÖ•‰π¶Á±çÂÜÖÂÆπ');
          return;
        }

        if (!deadlineInput) {
          alert('ËØ∑ÈÄâÊã©Êà™Ê≠¢Êó•Êúü');
          return;
        }

        const deadline = new Date(deadlineInput).getTime();
        const now = Date.now();

        if (deadline <= now) {
          alert('Êà™Ê≠¢Êó•ÊúüÂøÖÈ°ªÊòØÊú™Êù•ÁöÑÊó•Êúü');
          return;
        }

        const newBook = {
          id: 'book_' + Date.now(),
          name: name,
          content: content,
          format: this.state.currentFormat,
          targetRounds: targetRounds,
          deadline: deadline,
          folderId: folderId,
          blocks: [],
          createdAt: now
        };

        this.data.books.push(newBook);
        this.saveData();
        this.hideAddBookModal();
        this.renderBookList();
        this.updateGlobalStats();
        this.selectBook(newBook.id);

        alert('‚úÖ ‰π¶Á±çÊ∑ªÂä†ÊàêÂäüÔºÅ');
      },
      showEditBookModal(bookId) {
        this.state.editingBookId = bookId;
        const book = this.data.books.find(b => b.id === bookId);
        if (!book) return;

        document.getElementById('editBookName').value = book.name;
        document.getElementById('editTargetRounds').value = book.targetRounds || 8;
        
        if (book.deadline) {
          const deadlineDate = new Date(book.deadline);
          document.getElementById('editDeadlineDate').valueAsDate = deadlineDate;
        }

        const stats = this.calculateBookStats(book);
        const statsText = `
          üìù ÊÄªÂå∫ÂùóÊï∞: ${stats.totalBlocks}<br>
          ‚úÖ Â∑≤Â≠¶‰π†Âå∫Âùó: ${stats.studiedBlocks}<br>
          üìä ÊÄªÂ≠¶‰π†Ê¨°Êï∞: ${stats.totalStudies}<br>
          üéØ ÁõÆÊ†áÊÄªÊ¨°Êï∞: ${stats.totalBlocks * book.targetRounds}<br>
          üìà ÂÆåÊàêËøõÂ∫¶: ${stats.totalBlocks > 0 ? Math.round((stats.totalStudies / (stats.totalBlocks * book.targetRounds)) * 100) : 0}%
        `;
        
        document.getElementById('editCurrentStatsText').innerHTML = statsText;
        document.getElementById('editCurrentStats').style.display = 'block';
        
        this.updateEditPlanPreview();
        document.getElementById('editBookModal').classList.add('show');
      },

      hideEditBookModal() {
        document.getElementById('editBookModal').classList.remove('show');
        this.state.editingBookId = null;
      },

      updateEditPlanPreview() {
        const book = this.data.books.find(b => b.id === this.state.editingBookId);
        if (!book) return;

        const rounds = parseInt(document.getElementById('editTargetRounds').value) || 8;
        const deadlineInput = document.getElementById('editDeadlineDate').value;
        
        if (!deadlineInput) {
          document.getElementById('editPlanPreview').style.display = 'none';
          return;
        }

        const deadline = new Date(deadlineInput).getTime();
        const now = Date.now();
        const days = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
        
        if (days <= 0) {
          document.getElementById('editPlanPreview').className = 'info-box danger';
          document.getElementById('editPlanPreviewText').innerHTML = 
            '‚ö†Ô∏è Êà™Ê≠¢Êó•ÊúüÂ∑≤ËøáÊúüÔºåËØ∑ÈÄâÊã©Êú™Êù•ÁöÑÊó•Êúü';
          document.getElementById('editPlanPreview').style.display = 'block';
          return;
        }

        const stats = this.calculateBookStats(book);
        const remainingStudies = Math.max(0, (book.blocks.length * rounds) - stats.totalStudies);
        
        if (remainingStudies === 0) {
          document.getElementById('editPlanPreview').className = 'info-box success';
          document.getElementById('editPlanPreviewText').innerHTML = 
            'üéâ Â∑≤ÂÆåÊàêÊâÄÊúâÂ≠¶‰π†ÁõÆÊ†áÔºÅ';
          document.getElementById('editPlanPreview').style.display = 'block';
          return;
        }

        const requiredSpeed = remainingStudies / days;
        const avgInterval = (days / remainingStudies).toFixed(1);
        
        let className = 'info-box';
        let message = `Ââ©‰Ωô <strong>${days}Â§©</strong>ÔºåÈúÄÂÆåÊàê <strong>${remainingStudies}Ê¨°</strong> Â≠¶‰π†<br>`;
        message += `ÈúÄË¶ÅÈÄüÂ∫¶Ôºö<strong>${requiredSpeed.toFixed(1)}Ê¨°/Â§©</strong><br>`;
        message += `Âπ≥ÂùáÈó¥ÈöîÔºö<strong>${avgInterval}Â§©</strong> Â≠¶‰π†‰∏ÄÊ¨°<br>`;
        
        const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
        let recentStudies = 0;
        book.blocks.forEach(block => {
          if (block.studyRecords) {
            recentStudies += block.studyRecords.filter(r => r.timestamp > sevenDaysAgo).length;
          }
        });
        const currentSpeed = recentStudies / 7;
        
        if (currentSpeed > 0) {
          message += `ÂΩìÂâçÈÄüÂ∫¶Ôºö<strong>${currentSpeed.toFixed(1)}Ê¨°/Â§©</strong><br>`;
          
          if (currentSpeed >= requiredSpeed) {
            className = 'info-box success';
            message += '‚úÖ ÂΩìÂâçÈÄüÂ∫¶ËâØÂ•ΩÔºåÊåâÊ≠§ËøõÂ∫¶ÂèØÊåâÊó∂ÂÆåÊàê';
          } else {
            const speedUpPercent = ((requiredSpeed / currentSpeed - 1) * 100).toFixed(0);
            className = 'info-box warning';
            message += `‚ö° ÈúÄË¶ÅÊèêÈÄü <strong>${speedUpPercent}%</strong> ÊâçËÉΩÊåâÊó∂ÂÆåÊàê`;
          }
        }

        document.getElementById('editPlanPreview').className = className;
        document.getElementById('editPlanPreviewText').innerHTML = message;
        document.getElementById('editPlanPreview').style.display = 'block';
      },

      calculateBookStats(book) {
        const totalBlocks = book.blocks.length;
        let studiedBlocks = 0;
        let totalStudies = 0;
        let remainingStudies = 0;

        book.blocks.forEach(block => {
          const studyCount = block.studyRecords?.length || 0;
          if (studyCount > 0) {
            studiedBlocks++;
          }
          totalStudies += studyCount;
          remainingStudies += Math.max(0, book.targetRounds - studyCount);
        });

        const now = Date.now();
        const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
        let recentStudies = 0;
        
        book.blocks.forEach(block => {
          if (block.studyRecords) {
            recentStudies += block.studyRecords.filter(r => r.timestamp > sevenDaysAgo).length;
          }
        });
        
        const currentSpeed = recentStudies / 7;
        const daysLeft = book.deadline ? Math.max(0, (book.deadline - now) / (1000 * 60 * 60 * 24)) : 0;
        const requiredSpeed = daysLeft > 0 ? remainingStudies / daysLeft : 0;

        return {
          totalBlocks,
          studiedBlocks,
          totalStudies,
          remainingStudies,
          currentSpeed,
          requiredSpeed
        };
      },

      saveBookSettings() {
        const book = this.data.books.find(b => b.id === this.state.editingBookId);
        if (!book) return;

        const name = document.getElementById('editBookName').value.trim();
        const targetRounds = parseInt(document.getElementById('editTargetRounds').value);
        const deadlineInput = document.getElementById('editDeadlineDate').value;

        if (!name) {
          alert('ËØ∑ËæìÂÖ•‰π¶Á±çÂêçÁß∞');
          return;
        }

        if (!deadlineInput) {
          alert('ËØ∑ÈÄâÊã©Êà™Ê≠¢Êó•Êúü');
          return;
        }

        const deadline = new Date(deadlineInput).getTime();
        const now = Date.now();

        if (deadline <= now) {
          alert('Êà™Ê≠¢Êó•ÊúüÂøÖÈ°ªÊòØÊú™Êù•ÁöÑÊó•Êúü');
          return;
        }

        book.name = name;
        book.targetRounds = targetRounds;
        book.deadline = deadline;

        this.saveData();
        this.hideEditBookModal();
        this.renderBookList();
        this.updateGlobalStats();
        
        if (this.data.currentBookId === book.id) {
          this.renderBookContent();
        }

        alert('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
      },

      deleteBook() {
        if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊú¨‰π¶Á±çÂêóÔºüÊâÄÊúâÂ≠¶‰π†ËÆ∞ÂΩïÂ∞ÜË¢´Ê∏ÖÈô§ÔºÅ')) {
          return;
        }

        const index = this.data.books.findIndex(b => b.id === this.state.editingBookId);
        if (index > -1) {
          this.data.books.splice(index, 1);
          
          if (this.data.currentBookId === this.state.editingBookId) {
            this.data.currentBookId = null;
          }

          this.saveData();
          this.hideEditBookModal();
          this.renderBookList();
          this.updateGlobalStats();
          this.renderBookContent();
          this.updateTaskList();

          alert('‚úÖ ‰π¶Á±çÂ∑≤Âà†Èô§');
        }
      },

      // ========== ÁºñËæë‰π¶Á±çÂÜÖÂÆπÂäüËÉΩ ==========
      showEditContentModal() {
        const book = this.data.books.find(b => b.id === this.state.editingBookId);
        if (!book) return;

        // Âè™ÈöêËóèÁºñËæëËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÔºå‰ΩÜ‰øùÁïô editingBookId
        document.getElementById('editBookModal').classList.remove('show');
        
        document.getElementById('editBookContent').value = book.content;
        this.state.editFormat = book.format || 'text';
        
        if (this.state.editFormat === 'markdown') {
          document.getElementById('editFormatMarkdown').classList.add('active');
          document.getElementById('editFormatText').classList.remove('active');
        } else {
          document.getElementById('editFormatText').classList.add('active');
          document.getElementById('editFormatMarkdown').classList.remove('active');
        }
        
        document.getElementById('editContentModal').classList.add('show');
      },

      hideEditContentModal() {
        document.getElementById('editContentModal').classList.remove('show');
      },

      saveBookContent() {
        const book = this.data.books.find(b => b.id === this.state.editingBookId);
        if (!book) return;

        const newContent = document.getElementById('editBookContent').value.trim();
        
        if (!newContent) {
          alert('ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫');
          return;
        }

        const oldLines = book.content.split('\n');
        const newLines = newContent.split('\n');
        const hasBlocks = book.blocks && book.blocks.length > 0;
        
        if (hasBlocks) {
          // Êô∫ËÉΩ‰øùÁïôÔºöÊ£ÄÊü•ÊØè‰∏™Â≠¶‰π†Âå∫ÂùóÁöÑÂÜÖÂÆπÊòØÂê¶ÊîπÂèò
          const originalBlockCount = book.blocks.length;
          const validBlocks = [];
          const removedBlocks = [];
          
          book.blocks.forEach(block => {
            // Ê£ÄÊü•Â≠¶‰π†Âå∫ÂùóÁöÑË°åÂè∑ÊòØÂê¶ËøòÊúâÊïà
            if (block.endLine >= newLines.length) {
              removedBlocks.push(block);
              return;
            }
            
            // Ê£ÄÊü•Â≠¶‰π†Âå∫ÂùóÁöÑÂÜÖÂÆπÊòØÂê¶ÂÆåÂÖ®‰∏ÄËá¥
            let contentMatch = true;
            for (let i = block.startLine; i <= block.endLine && i < Math.min(oldLines.length, newLines.length); i++) {
              if (oldLines[i] !== newLines[i]) {
                contentMatch = false;
                break;
              }
            }
            
            if (contentMatch && block.endLine < newLines.length) {
              validBlocks.push(block);
            } else {
              removedBlocks.push(block);
            }
          });
          
          const removedCount = removedBlocks.length;
          const keptCount = validBlocks.length;
          
          let message = `üìù Êô∫ËÉΩÊ£ÄÊµãÁªìÊûúÔºö\n\n`;
          message += `‚Ä¢ ÂéüÊúâÂ≠¶‰π†Âå∫ÂùóÔºö${originalBlockCount} ‰∏™\n`;
          message += `‚Ä¢ ‰øùÁïôÔºàÊú™ÊîπÂä®ÔºâÔºö${keptCount} ‰∏™\n`;
          message += `‚Ä¢ Ê∏ÖÈô§ÔºàÂ∑≤ÊîπÂä®ÔºâÔºö${removedCount} ‰∏™\n\n`;
          
          if (removedCount > 0) {
            const totalStudies = removedBlocks.reduce((sum, b) => sum + (b.studyRecords?.length || 0), 0);
            message += `‚ö†Ô∏è ${removedCount} ‰∏™ÊîπÂä®Âå∫ÂùóÁöÑÂ≠¶‰π†ËÆ∞ÂΩïÔºàÂÖ±${totalStudies}Ê¨°ÔºâÂ∞ÜË¢´Ê∏ÖÈô§\n\n`;
          }
          
          message += `Á°ÆÂÆöË¶Å‰øùÂ≠ò‰øÆÊîπÂêóÔºü`;
          
          if (!confirm(message)) {
            return;
          }
          
          // Â∫îÁî®Êô∫ËÉΩ‰øùÁïô
          book.blocks = validBlocks;
        }

        book.content = newContent;
        book.format = this.state.editFormat;

        this.saveData();
        this.hideEditContentModal();
        
        if (this.data.currentBookId === book.id) {
          this.renderBookContent();
        }
        
        this.updateGlobalStats();
        this.updateTaskList();

        if (hasBlocks) {
          const keptCount = book.blocks.length;
          if (keptCount > 0) {
            alert(`‚úÖ ÂÜÖÂÆπÂ∑≤Êõ¥Êñ∞ÔºÅ\n\nÊô∫ËÉΩ‰øùÁïô‰∫Ü ${keptCount} ‰∏™Êú™ÊîπÂä®ÁöÑÂ≠¶‰π†Âå∫Âùó„ÄÇ`);
          } else {
            alert('‚úÖ ÂÜÖÂÆπÂ∑≤Êõ¥Êñ∞ÔºÅ\n\nÊâÄÊúâÂ≠¶‰π†Âå∫ÂùóÈÉΩË¢´ÊîπÂä®ÔºåÂ∑≤ÂÖ®ÈÉ®Ê∏ÖÈô§„ÄÇ');
          }
        } else {
          alert('‚úÖ ÂÜÖÂÆπÂ∑≤Êõ¥Êñ∞ÔºÅ');
        }
      },

      renderBookList() {
        const container = document.getElementById('bookList');
        if (this.data.books.length === 0 && this.data.folders.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìñ</div>
              <p>ËøòÊ≤°ÊúâÊ∑ªÂä†‰π¶Á±ç</p>
              <p style="font-size: 12px; margin-top: 5px;">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂºÄÂßã</p>
            </div>
          `;
          return;
        }

        const now = Date.now();
        let html = '';

        // Ê∏≤ÊüìÊñá‰ª∂Â§π
        this.data.folders.forEach(folder => {
          const booksInFolder = this.data.books.filter(b => b.folderId === folder.id);
          const isCollapsed = this.state.collapsedFolders.has(folder.id);
          const toggleIcon = isCollapsed ? '‚ñ∂' : '‚ñº';

          html += `
            <div class="folder-item" onclick="app.toggleFolder('${folder.id}')">
              <span class="folder-toggle ${isCollapsed ? 'collapsed' : ''}">${toggleIcon}</span>
              <span class="folder-icon">${folder.icon}</span>
              <span class="folder-name">${this.escapeHtml(folder.name)}</span>
              <span class="folder-count">${booksInFolder.length}</span>
              <button class="folder-settings-btn" onclick="event.stopPropagation(); app.deleteFolder('${folder.id}')">üóëÔ∏è</button>
            </div>
          `;

          // Ê∏≤ÊüìÊñá‰ª∂Â§π‰∏≠ÁöÑ‰π¶Á±ç
          if (!isCollapsed && booksInFolder.length > 0) {
            html += '<div class="folder-books">';
            html += booksInFolder.map(book => this.renderBookItem(book, now)).join('');
            html += '</div>';
          }
        });

        // Ê∏≤ÊüìÊ†πÁõÆÂΩïÁöÑ‰π¶Á±ç
        const rootBooks = this.data.books.filter(b => !b.folderId);
        html += rootBooks.map(book => this.renderBookItem(book, now)).join('');

        container.innerHTML = html;
      },

      renderBookItem(book, now) {
        const stats = this.calculateBookStats(book);
        const progress = stats.totalBlocks > 0 
          ? Math.round((stats.totalStudies / (stats.totalBlocks * book.targetRounds)) * 100) 
          : 0;
        
        let deadlineInfo = '';
        let deadlineClass = '';
        
        if (book.deadline) {
          const daysLeft = Math.ceil((book.deadline - now) / (1000 * 60 * 60 * 24));
          
          if (daysLeft < 0) {
            deadlineInfo = `‚ö†Ô∏è Â∑≤Ë∂ÖÊúü ${Math.abs(daysLeft)} Â§©`;
            deadlineClass = 'danger';
          } else if (stats.remainingStudies > 0) {
            const onTrack = stats.currentSpeed >= stats.requiredSpeed;
            
            if (daysLeft <= 7) {
              deadlineClass = 'danger';
              deadlineInfo = `üî• Ââ©‰Ωô${daysLeft}Â§© | ÈúÄ${stats.requiredSpeed.toFixed(1)}Ê¨°/Â§©`;
            } else if (!onTrack && stats.currentSpeed > 0) {
              deadlineClass = 'warning';
              const speedUp = ((stats.requiredSpeed / stats.currentSpeed - 1) * 100).toFixed(0);
              deadlineInfo = `‚ö° Ââ©‰Ωô${daysLeft}Â§© | ÈúÄÊèêÈÄü${speedUp}%`;
            } else {
              deadlineClass = 'success';
              deadlineInfo = `‚úÖ Ââ©‰Ωô${daysLeft}Â§© | ËøõÂ∫¶ËâØÂ•Ω`;
            }
          } else {
            deadlineClass = 'success';
            deadlineInfo = `üéâ Â∑≤ÂÆåÊàêÁõÆÊ†áÔºÅ`;
          }
        }
        
        return `
          <div class="book-item ${book.id === this.data.currentBookId ? 'active' : ''}" 
               onclick="app.selectBook('${book.id}')">
            <button class="book-settings-btn" onclick="event.stopPropagation(); app.showEditBookModal('${book.id}')">‚öôÔ∏è</button>
            <div class="book-item-name">${this.escapeHtml(book.name)}</div>
            <div class="book-item-progress">
              üìä ËøõÂ∫¶: ${stats.totalStudies}/${stats.totalBlocks * book.targetRounds} (${progress}%)<br>
              üìù Âå∫Âùó: ${stats.studiedBlocks}/${stats.totalBlocks}<br>
              üéØ ÁõÆÊ†á: ${book.targetRounds}Ê¨°/Âå∫Âùó
            </div>
            ${deadlineInfo ? `<div class="book-item-deadline ${deadlineClass}">${deadlineInfo}</div>` : ''}
          </div>
        `;
      },

      selectBook(bookId) {
        this.data.currentBookId = bookId;
        this.saveData();
        this.renderBookList();
        this.renderBookContent();
        this.updateTaskList();
        this.updateStatsList();
      },

      // ========== ÂÜÖÂÆπÊ∏≤ÊüìÂäüËÉΩ ==========
renderBookContent() {
  const book = this.data.books.find(b => b.id === this.data.currentBookId);
  if (!book) {
    document.getElementById('contentText').innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìÑ</div>
        <p>ËØ∑ÈÄâÊã©‰∏ÄÊú¨‰π¶Á±çÂºÄÂßãÂ≠¶‰π†</p>
      </div>
    `;
    return;
  }

  let html = '';
  const lines = book.content.split('\n');
  let lineIndex = 0;

  // Áªü‰∏ÄÂ§ÑÁêÜÔºöÊó†ËÆ∫ÊòØ Markdown ËøòÊòØÁ∫ØÊñáÊú¨ÔºåÈÉΩÊåâË°åÂ§ÑÁêÜ
  while (lineIndex < lines.length) {
    const block = book.blocks.find(b => b.startLine === lineIndex);
    
    if (block) {
      const color = this.getBlockColor(book.id, block.id);
      const studyCount = block.studyRecords?.length || 0;
      const blockLines = lines.slice(block.startLine, block.endLine + 1);
      const isImportant = block.important || false;
      const importantClass = isImportant ? 'important' : '';
      const importantBtnClass = isImportant ? 'active' : '';
      
      html += `
        <div class="study-block ${importantClass}" style="background-color: ${color};" data-block-id="${block.id}">
          <div class="study-block-info">
            <span class="study-count">Â∑≤Â≠¶${studyCount}Ê¨°</span>
            <button class="study-important-btn ${importantBtnClass}" onclick="app.toggleImportant('${block.id}')" title="Ê†áËÆ∞‰∏∫ÈáçÁÇπ">‚≠ê</button>
            <button class="study-plus-btn" onclick="app.studyBlock('${block.id}')" title="Â≠¶‰π†+1">+</button>
            <button class="study-delete-btn" onclick="app.deleteBlock('${block.id}')" title="Âà†Èô§Âå∫Âùó">√ó</button>
          </div>
          ${this.renderBlockContent(blockLines, book)}
        </div>
      `;
      lineIndex = block.endLine + 1;
    } else {
      html += this.renderLine(lines[lineIndex], book, lineIndex);
      lineIndex++;
    }
  }

  document.getElementById('contentText').innerHTML = html;
},

// Êñ∞Â¢ûÔºöÊ∏≤ÊüìÂå∫ÂùóÂÜÖÂÆπÔºàÊîØÊåÅ MarkdownÔºâ
renderBlockContent(lines, book) {
  const content = lines.join('\n');
  
  if (book.format === 'markdown' && typeof marked !== 'undefined') {
    return marked.parse(content);
  } else {
    return lines.map(line => {
      const lineHtml = this.escapeHtml(line);
      return `<div class="text-line">${lineHtml}</div>`;
    }).join('');
  }
},

renderLine(line, book, lineIndex) {
  let content = '';
  
  // Markdown Ê†ºÂºèÔºöÊ∏≤ÊüìÂçïË°å
  if (book.format === 'markdown' && typeof marked !== 'undefined') {
    content = marked.parseInline(line) || '&nbsp;'; // Á©∫Ë°åÊòæÁ§∫Á©∫Ê†º
  } else {
    content = this.escapeHtml(line) || '&nbsp;';
  }
  
  const dataAttr = lineIndex !== undefined ? `data-line="${lineIndex}"` : '';
  
  return `<div class="text-line" ${dataAttr}>${content}</div>`;
},

      getBlockColor(bookId, blockId) {
        const seed = bookId.charCodeAt(0) + blockId.charCodeAt(0);
        return this.colors[seed % this.colors.length];
      },

      // ========== ÈÄâÊã©Ê®°ÂºèÂäüËÉΩ ==========
      toggleSelectMode() {
        this.state.selectMode = !this.state.selectMode;
        
        const btn = document.getElementById('selectModeBtn');
        
        if (this.state.selectMode) {
          btn.classList.add('active');
          this.enableSelectMode();
        } else {
          btn.classList.remove('active');
          this.disableSelectMode();
        }
      },

      enableSelectMode() {
        const lines = document.querySelectorAll('.text-line:not(.study-block .text-line)');
        lines.forEach(line => {
          line.classList.add('selecting');
          line.onclick = (e) => this.toggleLineSelection(e.target);
        });
      },

      disableSelectMode() {
        const lines = document.querySelectorAll('.text-line');
        lines.forEach(line => {
          line.classList.remove('selecting', 'selected');
          line.onclick = null;
        });
        this.state.selectedLines = [];
      },

      toggleLineSelection(lineElement) {
        if (!this.state.selectMode) return;
        
        const lineIndex = parseInt(lineElement.dataset.line);
        if (isNaN(lineIndex)) return;

        if (lineElement.classList.contains('selected')) {
          lineElement.classList.remove('selected');
          this.state.selectedLines = this.state.selectedLines.filter(l => l !== lineIndex);
        } else {
          lineElement.classList.add('selected');
          this.state.selectedLines.push(lineIndex);
        }

        if (this.state.selectedLines.length > 0) {
          this.showCreateBlockButton();
        } else {
          this.hideCreateBlockButton();
        }
      },

      showCreateBlockButton() {
        let btn = document.getElementById('createBlockBtn');
        if (!btn) {
          btn = document.createElement('button');
          btn.id = 'createBlockBtn';
          btn.className = 'btn btn-success';
          btn.style.position = 'fixed';
          btn.style.bottom = '30px';
          btn.style.right = '30px';
          btn.style.zIndex = '999';
          btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
          btn.textContent = `‚úÖ ÂàõÂª∫Â≠¶‰π†Âå∫Âùó (${this.state.selectedLines.length}Ë°å)`;
          btn.onclick = () => this.createStudyBlock();
          document.body.appendChild(btn);
        } else {
          btn.textContent = `‚úÖ ÂàõÂª∫Â≠¶‰π†Âå∫Âùó (${this.state.selectedLines.length}Ë°å)`;
        }
      },

      hideCreateBlockButton() {
        const btn = document.getElementById('createBlockBtn');
        if (btn) {
          btn.remove();
        }
      },

      createStudyBlock() {
        if (this.state.selectedLines.length === 0) return;

        const book = this.data.books.find(b => b.id === this.data.currentBookId);
        if (!book) return;

        this.state.selectedLines.sort((a, b) => a - b);
        const startLine = this.state.selectedLines[0];
        const endLine = this.state.selectedLines[this.state.selectedLines.length - 1];

        const overlap = book.blocks.some(block => {
          return !(endLine < block.startLine || startLine > block.endLine);
        });

        if (overlap) {
          alert('‚ùå ÊâÄÈÄâÂå∫Âüü‰∏éÁé∞ÊúâÂ≠¶‰π†Âå∫ÂùóÈáçÂè†ÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©');
          return;
        }

        const newBlock = {
          id: 'block_' + Date.now(),
          startLine: startLine,
          endLine: endLine,
          studyRecords: [],
          createdAt: Date.now()
        };

        book.blocks.push(newBlock);
        book.blocks.sort((a, b) => a.startLine - b.startLine);

        this.saveData();
        this.toggleSelectMode();
        this.renderBookContent();
        this.updateGlobalStats();
        this.updateTaskList();
        this.updateStatsList();

        alert('‚úÖ Â≠¶‰π†Âå∫ÂùóÂàõÂª∫ÊàêÂäüÔºÅ');
      },

      studyBlock(blockId) {
        const book = this.data.books.find(b => b.id === this.data.currentBookId);
        if (!book) return;

        const block = book.blocks.find(b => b.id === blockId);
        if (!block) return;

        if (!block.studyRecords) {
          block.studyRecords = [];
        }

        block.studyRecords.push({
          timestamp: Date.now()
        });

        this.data.studyStats.studyHistory.push({
          bookId: book.id,
          blockId: block.id,
          timestamp: Date.now()
        });

        this.saveData();
        this.renderBookContent();
        this.updateGlobalStats();
        this.updateTaskList();
        this.updateStatsList();

        const studyCount = block.studyRecords.length;
        const remaining = Math.max(0, book.targetRounds - studyCount);
        
        if (remaining === 0) {
          alert(`üéâ ÊÅ≠ÂñúÔºÅÊ≠§Âå∫ÂùóÂ∑≤ÂÆåÊàêÁõÆÊ†áÂ≠¶‰π†Ê¨°Êï∞ÔºÅ`);
        } else {
          alert(`‚úÖ Â≠¶‰π†ËÆ∞ÂΩïÂ∑≤Ê∑ªÂä†ÔºÅ\nÂΩìÂâç: ${studyCount}Ê¨°\nÂâ©‰Ωô: ${remaining}Ê¨°`);
        }
      },

      deleteBlock(blockId) {
        const book = this.data.books.find(b => b.id === this.data.currentBookId);
        if (!book) return;

        const block = book.blocks.find(b => b.id === blockId);
        if (!block) return;

        const studyCount = block.studyRecords?.length || 0;
        if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â≠¶‰π†Âå∫ÂùóÂêóÔºü\nÂ∑≤Â≠¶‰π† ${studyCount} Ê¨°ÁöÑËÆ∞ÂΩïÂ∞ÜË¢´Ê∏ÖÈô§„ÄÇ`)) {
          return;
        }

        const index = book.blocks.findIndex(b => b.id === blockId);
        if (index > -1) {
          book.blocks.splice(index, 1);
          this.saveData();
          this.renderBookContent();
          this.updateGlobalStats();
          this.updateTaskList();
          this.updateStatsList();
          alert('‚úÖ Â≠¶‰π†Âå∫ÂùóÂ∑≤Âà†Èô§');
        }
      },

      toggleImportant(blockId) {
        const book = this.data.books.find(b => b.id === this.data.currentBookId);
        if (!book) return;

        const block = book.blocks.find(b => b.id === blockId);
        if (!block) return;

        block.important = !block.important;
        this.saveData();
        this.renderBookContent();
      },


      // ========== ‰ªªÂä°Èù¢ÊùøÂäüËÉΩ ==========
      switchTaskTab(tab) {
        this.state.currentTaskTab = tab;
        
        document.querySelectorAll('.task-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        if (tab === 'tasks') {
          document.getElementById('taskList').style.display = 'block';
          document.getElementById('statsList').style.display = 'none';
          document.getElementById('taskPanelTitle').textContent = 'Â≠¶‰π†‰ªªÂä°';
          this.updateTaskList();
        } else {
          document.getElementById('taskList').style.display = 'none';
          document.getElementById('statsList').style.display = 'block';
          document.getElementById('taskPanelTitle').textContent = 'Â≠¶‰π†ÁªüËÆ°';
          this.updateStatsList();
        }
      },

      updateTaskList() {
        const container = document.getElementById('taskList');
        const tasks = this.generateTaskList();

        if (tasks.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚úÖ</div>
              <p>ÊöÇÊó†ÂæÖÂ≠¶‰π†‰ªªÂä°</p>
            </div>
          `;
          document.getElementById('taskCount').textContent = '0';
          return;
        }

        document.getElementById('taskCount').textContent = tasks.length;

        container.innerHTML = tasks.map(task => {
          const preview = task.content.substring(0, 50) + (task.content.length > 50 ? '...' : '');
          return `
            <div class="task-item ${task.urgency}" onclick="app.jumpToTask('${task.bookId}', '${task.blockId}')">
              <div class="task-item-book">${this.escapeHtml(task.bookName)}</div>
              <div class="task-item-preview">${this.escapeHtml(preview)}</div>
              <div class="task-item-meta">
                <span>Â∑≤Â≠¶${task.studyCount}/${task.targetRounds}Ê¨°</span>
                <span>${task.daysLeftText}</span>
              </div>
            </div>
          `;
        }).join('');
      },

      generateTaskList() {
        const now = Date.now();
        const tasks = [];

        this.data.books.forEach(book => {
          if (!book.deadline) return;

          const daysLeft = Math.ceil((book.deadline - now) / (1000 * 60 * 60 * 24));
          
          book.blocks.forEach(block => {
            const studyCount = block.studyRecords?.length || 0;
            const remaining = book.targetRounds - studyCount;
            
            if (remaining <= 0) return;

            const requiredInterval = daysLeft / remaining;
            const lastStudy = block.studyRecords?.length > 0 
              ? block.studyRecords[block.studyRecords.length - 1].timestamp 
              : book.createdAt;
            const daysSinceLastStudy = (now - lastStudy) / (1000 * 60 * 60 * 24);

            let urgency = 'normal';
            if (daysLeft <= 3 || daysSinceLastStudy >= requiredInterval * 1.5) {
              urgency = 'urgent';
            } else if (daysLeft <= 7 || daysSinceLastStudy >= requiredInterval) {
              urgency = 'due-soon';
            }

            const lines = book.content.split('\n');
            const content = lines.slice(block.startLine, block.endLine + 1).join(' ');

            tasks.push({
              bookId: book.id,
              blockId: block.id,
              bookName: book.name,
              content: content,
              studyCount: studyCount,
              targetRounds: book.targetRounds,
              daysLeft: daysLeft,
              daysLeftText: daysLeft > 0 ? `Ââ©${daysLeft}Â§©` : 'Â∑≤Ë∂ÖÊúü',
              urgency: urgency,
              daysSinceLastStudy: daysSinceLastStudy
            });
          });
        });

        tasks.sort((a, b) => {
          const urgencyOrder = { urgent: 0, 'due-soon': 1, normal: 2 };
          if (urgencyOrder[a.urgency] !== urgencyOrder[b.urgency]) {
            return urgencyOrder[a.urgency] - urgencyOrder[b.urgency];
          }
          return b.daysSinceLastStudy - a.daysSinceLastStudy;
        });

        return tasks;
      },

      updateStatsList() {
        const container = document.getElementById('statsList');
        const allBlocks = [];

        this.data.books.forEach(book => {
          book.blocks.forEach(block => {
            const lines = book.content.split('\n');
            const content = lines.slice(block.startLine, block.endLine + 1).join(' ');
            const studyCount = block.studyRecords?.length || 0;
            
            allBlocks.push({
              bookId: book.id,
              blockId: block.id,
              bookName: book.name,
              content: content,
              studyCount: studyCount,
              targetRounds: book.targetRounds,
              progress: book.targetRounds > 0 ? (studyCount / book.targetRounds * 100) : 0
            });
          });
        });

        if (allBlocks.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <p>ÊöÇÊó†Â≠¶‰π†ËÆ∞ÂΩï</p>
            </div>
          `;
          document.getElementById('taskCount').textContent = '0';
          return;
        }

        allBlocks.sort((a, b) => b.studyCount - a.studyCount);

        document.getElementById('taskCount').textContent = allBlocks.length;

        container.innerHTML = allBlocks.map(block => {
          const preview = block.content.substring(0, 60) + (block.content.length > 60 ? '...' : '');
          return `
            <div class="stats-block-item" onclick="app.jumpToTask('${block.bookId}', '${block.blockId}')">
              <div class="stats-block-book">${this.escapeHtml(block.bookName)}</div>
              <div class="stats-block-content">${this.escapeHtml(preview)}</div>
              <div class="stats-block-progress">
                <span>${block.studyCount}Ê¨°</span>
                <div class="stats-block-bar">
                  <div class="stats-block-bar-fill" style="width: ${Math.min(block.progress, 100)}%"></div>
                </div>
                <span>${block.studyCount}/${block.targetRounds}</span>
              </div>
            </div>
          `;
        }).join('');
      },

      jumpToTask(bookId, blockId) {
        if (this.data.currentBookId !== bookId) {
          this.selectBook(bookId);
        }

        setTimeout(() => {
          const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
          if (blockElement) {
            blockElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            blockElement.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.5)';
            setTimeout(() => {
              blockElement.style.boxShadow = '';
            }, 2000);
          }
        }, 300);
      },
      // ========== Êï∞ÊçÆÂØºÂÖ•ÂØºÂá∫ÂäüËÉΩ ==========
      exportData() {
        const dataStr = JSON.stringify(this.data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
        a.download = `Â≠¶‰π†ËøõÂ∫¶_${dateStr}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Â≠¶‰π†ËøõÂ∫¶Â∑≤ÂØºÂá∫ÔºÅ');
      },

      // ========== ÂêåÊ≠•ÂäüËÉΩ ==========
      showSyncModal() {
        document.getElementById('syncModal').classList.add('show');
        document.getElementById('qrcodeContainer').style.display = 'none';
        
        // ÊòæÁ§∫ÂΩìÂâçÊï∞ÊçÆÂ§ßÂ∞è
        const dataStr = JSON.stringify(this.data);
        const originalSize = new Blob([dataStr]).size;
        
        let compressedSize = originalSize;
        if (typeof LZString !== 'undefined') {
          const compressed = LZString.compressToBase64(dataStr);
          compressedSize = new Blob([compressed]).size;
        }
        
        const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
        
        document.getElementById('syncStats').innerHTML = 
          `üìä ÂΩìÂâçÊï∞ÊçÆÔºöÂéüÂßã ${(originalSize/1024).toFixed(1)}KBÔºåÂéãÁº©Âêé ${(compressedSize/1024).toFixed(1)}KBÔºàÂáèÂ∞ë${compressionRatio}%Ôºâ`;
        
        // Ê†πÊçÆÊï∞ÊçÆÂ§ßÂ∞èÊõ¥Êñ∞Âª∫ËÆÆ
        const compressedKB = compressedSize / 1024;
        let recommendation = '';
        if (compressedKB < 10) {
          recommendation = `‚úÖ Êï∞ÊçÆÈáèËæÉÂ∞èÔºà${compressedKB.toFixed(1)}KBÔºâÔºåÊé®Ëçê‰ΩøÁî®Ââ™Ë¥¥ÊùøÂêåÊ≠•<br>ÂèØÁõ¥Êé•ÈÄöËøáÂæÆ‰ø°/QQÂèëÈÄÅ`;
        } else if (compressedKB < 50) {
          recommendation = `‚ö†Ô∏è Êï∞ÊçÆÈáèÈÄÇ‰∏≠Ôºà${compressedKB.toFixed(1)}KBÔºâÔºåÂª∫ËÆÆ‰ΩøÁî®Ôºö<br>‚Ä¢ Ââ™Ë¥¥ÊùøÂêåÊ≠•ÔºàÂèØËÉΩÈúÄË¶ÅÂàÜÊÆµÂèëÈÄÅÔºâ<br>‚Ä¢ ÊàñÊñá‰ª∂ÂêåÊ≠•ÔºàÊõ¥Á®≥ÂÆöÔºâ`;
        } else {
          recommendation = `‚ùå Êï∞ÊçÆÈáèËæÉÂ§ßÔºà${compressedKB.toFixed(1)}KBÔºâÔºåÂº∫ÁÉàÂª∫ËÆÆ‰ΩøÁî®Êñá‰ª∂ÂêåÊ≠•<br>ÈÅøÂÖçÈÄöËøáÂç≥Êó∂ÈÄöËÆØËΩØ‰ª∂ÂèëÈÄÅ`;
        }
        document.getElementById('syncRecommendation').innerHTML = recommendation;
      },

      hideSyncModal() {
        document.getElementById('syncModal').classList.remove('show');
      },

      async copyToClipboard(compress = true) {
        const dataStr = JSON.stringify(this.data);
        const originalSize = new Blob([dataStr]).size;
        
        let finalData = dataStr;
        let compressedSize = originalSize;
        
        if (compress && typeof LZString !== 'undefined') {
          // ‰ΩøÁî®ÂéãÁº©
          finalData = 'COMPRESSED:' + LZString.compressToBase64(dataStr);
          compressedSize = new Blob([finalData]).size;
        }
        
        const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
        
        try {
          await navigator.clipboard.writeText(finalData);
          
          const sizeInfo = compress 
            ? `\nüìä ÂéüÂßãÂ§ßÂ∞è: ${(originalSize/1024).toFixed(1)}KB\nüì¶ ÂéãÁº©Âêé: ${(compressedSize/1024).toFixed(1)}KB\n‚ú® ÂáèÂ∞ë: ${compressionRatio}%`
            : `\nüìä Êï∞ÊçÆÂ§ßÂ∞è: ${(originalSize/1024).toFixed(1)}KB`;
          
          alert(`‚úÖ Êï∞ÊçÆÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ${sizeInfo}\n\nÁé∞Âú®‰Ω†ÂèØ‰ª•Ôºö\n1. ÂèëÈÄÅÁªôËá™Â∑±ÔºàÂæÆ‰ø°/QQ/ÈÇÆ‰ª∂Ôºâ\n2. Âú®ÂÖ∂‰ªñËÆæÂ§áÊâìÂºÄÊ≠§È°µÈù¢\n3. ÁÇπÂáª"‰ªéÂâ™Ë¥¥ÊùøÂØºÂÖ•"`);
          
          // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
          if (compress) {
            document.getElementById('syncStats').innerHTML = 
              `‚úÖ Â∑≤ÂéãÁº©Ôºö${(originalSize/1024).toFixed(1)}KB ‚Üí ${(compressedSize/1024).toFixed(1)}KBÔºàÂáèÂ∞ë${compressionRatio}%Ôºâ`;
          }
        } catch (error) {
          // ÈôçÁ∫ßÊñπÊ°àÔºö‰ΩøÁî®‰º†ÁªüÁöÑÂ§çÂà∂ÊñπÊ≥ï
          const textarea = document.createElement('textarea');
          textarea.value = finalData;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          
          try {
            document.execCommand('copy');
            alert(`‚úÖ Êï∞ÊçÆÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ\nüìä Êï∞ÊçÆÂ§ßÂ∞è: ${(compressedSize/1024).toFixed(1)}KB`);
          } catch (err) {
            alert('‚ùå Â§çÂà∂Â§±Ë¥•ÔºåËØ∑Â∞ùËØï‰∏ãËΩΩÊñá‰ª∂ÊñπÂºèÂêåÊ≠•');
          }
          
          document.body.removeChild(textarea);
        }
      },

      async pasteFromClipboard() {
        try {
          const dataStr = await navigator.clipboard.readText();
          
          if (!dataStr || !dataStr.trim()) {
            alert('Ââ™Ë¥¥Êùø‰∏∫Á©∫ÔºåËØ∑ÂÖàÂ§çÂà∂Êï∞ÊçÆ');
            return;
          }

          this.importDataFromString(dataStr);
        } catch (error) {
          // Â¶ÇÊûúÊó†Ê≥ïËØªÂèñÂâ™Ë¥¥ÊùøÔºåÊèêÁ§∫Áî®Êà∑ÊâãÂä®Á≤òË¥¥
          const dataStr = prompt('ËØ∑Á≤òË¥¥Êï∞ÊçÆÔºö');
          if (dataStr) {
            this.importDataFromString(dataStr);
          }
        }
      },

      importDataFromString(dataStr) {
        try {
          let jsonStr = dataStr;
          let isCompressed = false;
          
          // Ê£ÄÊü•ÊòØÂê¶ÊòØÂéãÁº©Êï∞ÊçÆ
          if (dataStr.startsWith('COMPRESSED:')) {
            if (typeof LZString === 'undefined') {
              throw new Error('ÂéãÁº©Â∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
            try {
              jsonStr = LZString.decompressFromBase64(dataStr.substring(11));
              isCompressed = true;
              if (!jsonStr) {
                throw new Error('Ëß£ÂéãÁº©Â§±Ë¥•');
              }
            } catch (e) {
              throw new Error('Ëß£ÂéãÁº©Â§±Ë¥•ÔºåÊï∞ÊçÆÂèØËÉΩÂ∑≤ÊçüÂùè');
            }
          }
          
          const importedData = JSON.parse(jsonStr);
          
          if (!importedData.books || !Array.isArray(importedData.books)) {
            throw new Error('Êï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ');
          }

          const totalBlocks = importedData.books.reduce((sum, b) => sum + (b.blocks?.length || 0), 0);
          const totalStudies = importedData.books.reduce((sum, b) => 
            sum + (b.blocks?.reduce((s, block) => s + (block.studyRecords?.length || 0), 0) || 0), 0);
          
          const stats = `Âç≥Â∞ÜÂØºÂÖ•Ôºö\nüìö ${importedData.books.length} Êú¨‰π¶Á±ç\nüìù ${totalBlocks} ‰∏™Â≠¶‰π†Âå∫Âùó\n‚úÖ ${totalStudies} Ê¨°Â≠¶‰π†ËÆ∞ÂΩï${isCompressed ? '\nüì¶ Â∑≤Ëß£ÂéãÁº©Êï∞ÊçÆ' : ''}`;
          
          if (!confirm(`${stats}\n\n‚ö†Ô∏è ÂØºÂÖ•Êï∞ÊçÆÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`)) {
            return;
          }

          this.data = importedData;
          
          if (!this.data.studyStats) {
            this.data.studyStats = {
              totalStudyTime: 0,
              studyHistory: []
            };
          }

          this.data.books.forEach(book => {
            if (!book.blocks) book.blocks = [];
            if (!book.format) book.format = 'text';
          });

          this.saveData();
          this.hideSyncModal();
          this.renderBookList();
          this.updateGlobalStats();
          this.renderBookContent();
          this.updateTaskList();

          alert('‚úÖ Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºÅ');
        } catch (error) {
          alert('‚ùå ÂØºÂÖ•Â§±Ë¥•Ôºö' + error.message + '\n\nËØ∑Á°Æ‰øùÁ≤òË¥¥ÁöÑÊòØÊ≠£Á°ÆÁöÑÊï∞ÊçÆ');
        }
      },

      generateQRCode() {
        const dataStr = JSON.stringify(this.data);
        
        // Ê£ÄÊü•Êï∞ÊçÆÂ§ßÂ∞è
        const dataSize = new Blob([dataStr]).size;
        const maxSize = 2000; // ‰∫åÁª¥Á†ÅÂ§ßÂ∞èÈôêÂà∂Á∫¶2KB
        
        if (dataSize > maxSize) {
          alert(`‚ö†Ô∏è Êï∞ÊçÆÈáèËæÉÂ§ßÔºà${(dataSize/1024).toFixed(1)}KBÔºâÔºå‰∫åÁª¥Á†ÅÂèØËÉΩÊó†Ê≥ï‰ΩøÁî®\n\nÂª∫ËÆÆ‰ΩøÁî®Ôºö\n1. Ââ™Ë¥¥ÊùøÂêåÊ≠•ÔºàÊé®ËçêÔºâ\n2. Êñá‰ª∂ÂêåÊ≠•`);
          return;
        }

        // ÂàõÂª∫‰∏Ä‰∏™ÂåÖÂê´Êï∞ÊçÆÁöÑURL
        const pageUrl = window.location.href.split('?')[0];
        const syncUrl = `${pageUrl}?import=${encodeURIComponent(btoa(dataStr))}`;
        
        const container = document.getElementById('qrcodeContainer');
        const qrDiv = document.getElementById('qrcodeImage');
        qrDiv.innerHTML = '';
        
        // ‰ΩøÁî®Âú®Á∫ø‰∫åÁª¥Á†ÅÁîüÊàêÊúçÂä°
        const qrImg = document.createElement('img');
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(syncUrl)}`;
        qrImg.style.maxWidth = '100%';
        qrImg.onerror = () => {
          qrDiv.innerHTML = '<p style="color: red;">‰∫åÁª¥Á†ÅÁîüÊàêÂ§±Ë¥•ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÂêåÊ≠•ÊñπÂºè</p>';
        };
        qrDiv.appendChild(qrImg);
        
        container.style.display = 'block';
      },

      showImportFileDialog() {
        document.getElementById('importFileInput').click();
      },

      async handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
          const dataStr = await this.readTextFile(file);
          this.importDataFromString(dataStr);
          // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
          event.target.value = '';
        } catch (error) {
          alert('‚ùå Êñá‰ª∂ËØªÂèñÂ§±Ë¥•: ' + error.message);
        }
      },

      // ========== ÊâπÈáèÂØºÂÖ•ÂäüËÉΩ ==========
      showBatchImportModal() {
        document.getElementById('batchImportModal').classList.add('show');
        document.getElementById('batchFileInput').value = '';
        document.getElementById('batchFileList').style.display = 'none';
        document.getElementById('batchImportProgress').style.display = 'none';
        document.getElementById('batchTargetRounds').value = '8';
        
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 50);
        document.getElementById('batchDeadlineDate').valueAsDate = defaultDate;
        
        this.updateFolderSelects();
        this.updateBatchPlanPreview();
      },

      hideBatchImportModal() {
        document.getElementById('batchImportModal').classList.remove('show');
      },

      handleBatchFileSelection(event) {
        const files = Array.from(event.target.files);
        
        if (files.length === 0) {
          document.getElementById('batchFileList').style.display = 'none';
          return;
        }

        const listContent = files.map((file, index) => {
          const fileType = file.name.split('.').pop().toLowerCase();
          const icon = fileType === 'pdf' ? 'üìï' : fileType === 'md' ? 'üìò' : 'üìÑ';
          const size = (file.size / 1024).toFixed(1);
          return `
            <div style="padding: 8px; margin-bottom: 5px; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
              <span>${icon} ${file.name}</span>
              <span style="color: #666; font-size: 12px;">${size}KB</span>
            </div>
          `;
        }).join('');

        document.getElementById('batchFileListContent').innerHTML = listContent;
        document.getElementById('batchFileList').style.display = 'block';
        
        document.getElementById('batchImportBtn').textContent = `ÂºÄÂßãÂØºÂÖ•Ôºà${files.length}‰∏™Êñá‰ª∂Ôºâ`;
      },

      updateBatchPlanPreview() {
        const rounds = parseInt(document.getElementById('batchTargetRounds').value) || 8;
        const deadlineInput = document.getElementById('batchDeadlineDate').value;
        
        if (!deadlineInput) {
          document.getElementById('batchPlanPreview').style.display = 'none';
          return;
        }

        const deadline = new Date(deadlineInput).getTime();
        const now = Date.now();
        const days = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
        
        if (days <= 0) {
          document.getElementById('batchPlanPreview').className = 'info-box danger';
          document.getElementById('batchPlanPreviewText').innerHTML = 
            '‚ö†Ô∏è Êà™Ê≠¢Êó•ÊúüÂ∑≤ËøáÊúüÔºåËØ∑ÈÄâÊã©Êú™Êù•ÁöÑÊó•Êúü';
          document.getElementById('batchPlanPreview').style.display = 'block';
          return;
        }

        const avgInterval = (days / rounds).toFixed(1);
        
        let className = 'info-box';
        let message = `ÊâÄÊúâ‰π¶Á±çÂ∞ÜÂú® <strong>${days}Â§©</strong> ÂÜÖÂêÑÂÆåÊàê <strong>${rounds}Ê¨°</strong> Â≠¶‰π†<br>`;
        message += `Âπ≥ÂùáÊØè <strong>${avgInterval}Â§©</strong> Â≠¶‰π†‰∏ÄÊ¨°<br>`;
        message += `Êà™Ê≠¢Êó•ÊúüÔºö<strong>${new Date(deadline).toLocaleDateString('zh-CN')}</strong>`;
        
        if (parseFloat(avgInterval) < 2) {
          className = 'info-box warning';
          message += '<br>‚ö†Ô∏è Â≠¶‰π†ËäÇÂ•èËæÉÁ¥ßÂº†ÔºåÂª∫ËÆÆÈÄÇÂΩìË∞ÉÊï¥';
        } else if (parseFloat(avgInterval) > 10) {
          className = 'info-box success';
          message += '<br>‚úÖ Â≠¶‰π†ËäÇÂ•èÂÆΩÊùæÔºåÂèØ‰ª•‰ªéÂÆπÂÆâÊéí';
        } else {
          className = 'info-box';
          message += '<br>‚úÖ Â≠¶‰π†ËäÇÂ•èÈÄÇ‰∏≠';
        }

        document.getElementById('batchPlanPreview').className = className;
        document.getElementById('batchPlanPreviewText').innerHTML = message;
        document.getElementById('batchPlanPreview').style.display = 'block';
      },

      async processBatchImport() {
        const files = Array.from(document.getElementById('batchFileInput').files);
        
        if (files.length === 0) {
          alert('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂');
          return;
        }

        const targetRounds = parseInt(document.getElementById('batchTargetRounds').value) || 8;
        const deadlineInput = document.getElementById('batchDeadlineDate').value;
        const folderId = document.getElementById('batchFolder').value || null;

        if (!deadlineInput) {
          alert('ËØ∑ÈÄâÊã©Êà™Ê≠¢Êó•Êúü');
          return;
        }

        const deadline = new Date(deadlineInput).getTime();
        const now = Date.now();

        if (deadline <= now) {
          alert('Êà™Ê≠¢Êó•ÊúüÂøÖÈ°ªÊòØÊú™Êù•ÁöÑÊó•Êúü');
          return;
        }

        // ÊòæÁ§∫ËøõÂ∫¶Êù°
        document.getElementById('batchImportProgress').style.display = 'block';
        document.getElementById('batchImportBtn').disabled = true;
        document.getElementById('batchImportBtn').style.opacity = '0.5';

        let successCount = 0;
        let failCount = 0;
        const failedFiles = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const progress = ((i + 1) / files.length * 100).toFixed(0);
          
          document.getElementById('batchProgressText').innerHTML = 
            `Ê≠£Âú®ÂØºÂÖ•Ôºö${file.name}<br>ËøõÂ∫¶Ôºö${i + 1}/${files.length}`;
          document.getElementById('batchProgressBar').style.width = `${progress}%`;

          try {
            const content = await this.readFileContent(file);
            const fileType = file.name.split('.').pop().toLowerCase();
            const format = fileType === 'md' ? 'markdown' : 'text';
            const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '');

            const newBook = {
              id: 'book_' + Date.now() + '_' + i,
              name: nameWithoutExt,
              content: content,
              format: format,
              targetRounds: targetRounds,
              deadline: deadline,
              folderId: folderId,
              blocks: [],
              createdAt: now
            };

            this.data.books.push(newBook);
            successCount++;
            
            // Â∞èÂª∂ËøüÔºåËÆ©Áî®Êà∑ÁúãÂà∞ËøõÂ∫¶
            await new Promise(resolve => setTimeout(resolve, 100));
          } catch (error) {
            failCount++;
            failedFiles.push(file.name);
            console.error(`ÂØºÂÖ•Â§±Ë¥•: ${file.name}`, error);
          }
        }

        // ‰øùÂ≠òÊï∞ÊçÆ
        this.saveData();
        this.renderBookList();
        this.updateGlobalStats();

        // ÂÆåÊàêÊèêÁ§∫
        let message = `‚úÖ ÊâπÈáèÂØºÂÖ•ÂÆåÊàêÔºÅ\n\nÊàêÂäüÔºö${successCount}‰∏™\nÂ§±Ë¥•Ôºö${failCount}‰∏™`;
        if (failedFiles.length > 0) {
          message += `\n\nÂ§±Ë¥•ÁöÑÊñá‰ª∂Ôºö\n${failedFiles.join('\n')}`;
        }

        alert(message);

        // ÈáçÁΩÆÁïåÈù¢
        document.getElementById('batchImportBtn').disabled = false;
        document.getElementById('batchImportBtn').style.opacity = '1';
        
        if (successCount > 0) {
          this.hideBatchImportModal();
        } else {
          document.getElementById('batchImportProgress').style.display = 'none';
        }
      },

      async readFileContent(file) {
        const fileType = file.name.split('.').pop().toLowerCase();
        
        if (fileType === 'pdf') {
          return await this.extractPDFText(file);
        } else {
          return await this.readTextFile(file);
        }
      },

      // ========== AnkiÂØºÂá∫ÂäüËÉΩ ==========
      showAnkiExportModal() {
        document.getElementById('ankiExportModal').classList.add('show');
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂΩìÂâç‰π¶Á±ç
        const hasCurrentBook = this.data.currentBookId !== null;
        const bookSelect = document.getElementById('ankiBookSelect');
        if (!hasCurrentBook) {
          bookSelect.value = 'all';
          bookSelect.querySelector('option[value="current"]').disabled = true;
        } else {
          bookSelect.querySelector('option[value="current"]').disabled = false;
        }
        
        this.updateAnkiPreview();
      },

      hideAnkiExportModal() {
        document.getElementById('ankiExportModal').classList.remove('show');
      },

      updateAnkiPreview() {
        const bookSelect = document.getElementById('ankiBookSelect').value;
        const rangeSelect = document.getElementById('ankiRangeSelect').value;
        const cardType = document.getElementById('ankiCardType').value;
        
        // Êõ¥Êñ∞Âç°ÁâáÁ±ªÂûãÊèêÁ§∫
        const hint = document.getElementById('ankiCardTypeHint');
        if (cardType === 'basic') {
          hint.textContent = 'Âü∫Á°ÄÂç°ÁâáÔºö‰π¶Á±çÂêç+ÂÜÖÂÆπÁ¨¨‰∏ÄË°å ‚Üí ÂÆåÊï¥Âå∫ÂùóÂÜÖÂÆπ';
        } else {
          hint.textContent = 'Â°´Á©∫Âç°ÁâáÔºöÂ∞ÜÂå∫ÂùóÂÜÖÂÆπÂà∂‰ΩúÊàêÂ°´Á©∫È¢òÔºàÈúÄË¶ÅÊâãÂä®Ê†áËÆ∞{{c1::}}Ôºâ';
        }
        
        // Ëé∑ÂèñË¶ÅÂØºÂá∫ÁöÑÂå∫Âùó
        const blocks = this.getAnkiExportBlocks();
        
        if (blocks.length === 0) {
          document.getElementById('ankiPreview').style.display = 'none';
          return;
        }
        
        // ÁªüËÆ°‰ø°ÊÅØ
        const bookCount = new Set(blocks.map(b => b.bookId)).size;
        const importantCount = blocks.filter(b => b.important).length;
        
        let previewText = `Â∞ÜÂØºÂá∫ <strong>${blocks.length}</strong> ‰∏™Â≠¶‰π†Âå∫Âùó<br>`;
        previewText += `Ê∂âÂèä <strong>${bookCount}</strong> Êú¨‰π¶Á±ç<br>`;
        if (rangeSelect === 'important') {
          previewText += `<span style="color: #ffc107;">‚≠ê ‰ªÖÈáçÁÇπÂå∫Âùó</span>`;
        } else if (importantCount > 0) {
          previewText += `ÂÖ∂‰∏≠ <strong>${importantCount}</strong> ‰∏™ÈáçÁÇπÂå∫Âùó`;
        }
        
        document.getElementById('ankiPreviewText').innerHTML = previewText;
        document.getElementById('ankiPreview').style.display = 'block';
      },

      getAnkiExportBlocks() {
        const bookSelect = document.getElementById('ankiBookSelect').value;
        const rangeSelect = document.getElementById('ankiRangeSelect').value;
        
        let books = [];
        
        // ÈÄâÊã©‰π¶Á±ç
        if (bookSelect === 'current') {
          const currentBook = this.data.books.find(b => b.id === this.data.currentBookId);
          if (currentBook) {
            books = [currentBook];
          }
        } else {
          books = this.data.books;
        }
        
        // Êî∂ÈõÜÂå∫Âùó
        const blocks = [];
        books.forEach(book => {
          book.blocks.forEach((block, index) => {
            // Ê†πÊçÆËåÉÂõ¥ËøáÊª§
            if (rangeSelect === 'important' && !block.important) {
              return;
            }
            
            const lines = book.content.split('\n');
            const content = lines.slice(block.startLine, block.endLine + 1).join('\n');
            
            blocks.push({
              bookId: book.id,
              bookName: book.name,
              blockId: block.id,
              blockIndex: index + 1,
              content: content,
              studyCount: block.studyRecords?.length || 0,
              important: block.important || false,
              format: book.format
            });
          });
        });
        
        return blocks;
      },

      exportAnkiCards() {
        const blocks = this.getAnkiExportBlocks();
        
        if (blocks.length === 0) {
          alert('‚ùå Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂ≠¶‰π†Âå∫Âùó');
          return;
        }
        
        const cardType = document.getElementById('ankiCardType').value;
        const includeTags = document.getElementById('ankiIncludeTags').checked;
        
        let ankiText = '';
        
        if (cardType === 'basic') {
          // Âü∫Á°ÄÂç°ÁâáÊ†ºÂºèÔºöÊ≠£Èù¢\tËÉåÈù¢\tÊ†áÁ≠æ
          blocks.forEach(block => {
            // Ëé∑ÂèñÁ¨¨‰∏ÄË°å‰Ωú‰∏∫Ê†áÈ¢ò
            const cleanContent = this.stripHtmlAndMarkdown(block.content);
            const firstLine = cleanContent.split('\n')[0].trim();
            const title = firstLine.length > 50 ? firstLine.substring(0, 50) + '...' : firstLine;
            
            const front = `${block.bookName} - ${title}`;
            
            // ËÉåÈù¢ÊòØÂÆåÊï¥ÂÜÖÂÆπÔºàÂ¶ÇÊûúÂÜÖÂÆπÂ§öË°åÔºå‰ªéÁ¨¨‰∫åË°åÂºÄÂßãÔºõÂ¶ÇÊûúÂè™Êúâ‰∏ÄË°åÔºåÂ∞±ÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπÔºâ
            let back = cleanContent;
            
            // Â§ÑÁêÜÂ§öË°åÂÜÖÂÆπÔºå‰ΩøÁî®<br>ËøûÊé•
            back = back.replace(/\n/g, '<br>');
            
            let tags = '';
            if (includeTags) {
              tags = `${this.sanitizeAnkiTag(block.bookName)} Â≠¶‰π†${block.studyCount}Ê¨°`;
              if (block.important) {
                tags += ' ÈáçÁÇπ';
              }
            }
            
            ankiText += `${front}\t${back}`;
            if (tags) {
              ankiText += `\t${tags}`;
            }
            ankiText += '\n';
          });
        } else {
          // Â°´Á©∫Âç°ÁâáÊ†ºÂºèÔºöÂÜÖÂÆπÔºàÈúÄË¶ÅÊâãÂä®Ê†áËÆ∞{{c1::}}Ôºâ\tÊ†áÁ≠æ
          blocks.forEach(block => {
            let content = this.stripHtmlAndMarkdown(block.content);
            content = content.replace(/\n/g, '<br>');
            
            // Ê∑ªÂä†Ê≥®ÈáäÊèêÁ§∫Áî®Êà∑Ê†áËÆ∞Â°´Á©∫
            content = `<!-- ${block.bookName} - Âå∫Âùó${block.blockIndex} --><br>${content}`;
            
            let tags = '';
            if (includeTags) {
              tags = `${this.sanitizeAnkiTag(block.bookName)} Â≠¶‰π†${block.studyCount}Ê¨°`;
              if (block.important) {
                tags += ' ÈáçÁÇπ';
              }
            }
            
            ankiText += content;
            if (tags) {
              ankiText += `\t${tags}`;
            }
            ankiText += '\n';
          });
        }
        
        // ‰∏ãËΩΩÊñá‰ª∂
        const blob = new Blob([ankiText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
        const cardTypeStr = cardType === 'basic' ? 'Âü∫Á°Ä' : 'Â°´Á©∫';
        a.download = `AnkiÂç°Áâá_${cardTypeStr}_${dateStr}.txt`;
        
        a.click();
        URL.revokeObjectURL(url);
        
        alert(`‚úÖ AnkiÂç°ÁâáÂ∑≤ÁîüÊàêÔºÅ\n\nÂÖ±ÂØºÂá∫ ${blocks.length} Âº†Âç°Áâá\n\nÂØºÂÖ•Ê≠•È™§Ôºö\n1. Âú®Anki‰∏≠ÈÄâÊã©"Êñá‰ª∂‚ÜíÂØºÂÖ•"\n2. ÈÄâÊã©Âàö‰∏ãËΩΩÁöÑtxtÊñá‰ª∂\n3. Â≠óÊÆµÂàÜÈöîÁ¨¶ÈÄâÊã©"Âà∂Ë°®Á¨¶"\n4. ÂÆåÊàêÂØºÂÖ•`);
        
        this.hideAnkiExportModal();
      },

      stripHtmlAndMarkdown(text) {
        // ÁßªÈô§HTMLÊ†áÁ≠æ
        let result = text.replace(/<[^>]*>/g, '');
        
        // Â¶ÇÊûúÊòØmarkdownÔºåÁÆÄÂçïËΩ¨Êç¢‰∏Ä‰∫õÊ†ºÂºè
        result = result.replace(/^#+\s+/gm, ''); // ÁßªÈô§Ê†áÈ¢òÊ†áËÆ∞
        result = result.replace(/\*\*(.+?)\*\*/g, '$1'); // ÁßªÈô§Á≤ó‰Ωì
        result = result.replace(/\*(.+?)\*/g, '$1'); // ÁßªÈô§Êñú‰Ωì
        result = result.replace(/`(.+?)`/g, '$1'); // ÁßªÈô§Ë°åÂÜÖ‰ª£Á†Å
        
        return result.trim();
      },

      sanitizeAnkiTag(tag) {
        // AnkiÊ†áÁ≠æ‰∏çËÉΩÂåÖÂê´Á©∫Ê†ºÂíåÁâπÊÆäÂ≠óÁ¨¶
        return tag.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '_');
      },

      // ========== ÁßªÂä®Á´ØÂäüËÉΩ ==========
      toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
      },

      toggleTaskPanel() {
        document.getElementById('taskPanel').classList.toggle('show');
      },

      // ========== Â∑•ÂÖ∑ÂáΩÊï∞ ==========
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    };

    // ÂàùÂßãÂåñÂ∫îÁî®
    window.addEventListener('DOMContentLoaded', () => {
      app.init();
    });

    // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });
  </script>
</body>
</html>
